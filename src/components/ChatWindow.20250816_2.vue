<template>
  <!-- ‚úÖ Ï†ÑÏ≤¥ ÎìúÎûòÍ∑∏ Ïò§Î≤ÑÎ†àÏù¥ -->
  <div v-if="isDraggingFile" class="drag-overlay">
    <div class="drag-overlay-content">üìé Î¨¥ÏóáÏù¥Îì† Ï∂îÍ∞ÄÌïòÏÑ∏Ïöî</div>
  </div>

  <div class="chat-wrapper">
    <div v-if="errorMessage" class="error-toast" role="alert" aria-live="polite">
      {{ errorMessage }}
    </div>

    <!-- ‚úÖ Ìó§Îçî: Î°úÍ≥† + (Í∞íÎßå Î≥¥Ïù¥Îäî) ÌÉúÍ∑∏ + ÏÑ§Ï†ï -->
    <div class="chat-header">
      <img src="/logo.png" alt="Î°úÍ≥†" class="chat-logo" />
    
      <!-- Ïò§Î•∏Ï™Ω ÏòÅÏó≠ÏùÑ Î∞ÄÏñ¥ÎÇ¥Îäî Ïä§ÌéòÏù¥ÏÑú -->
      <div class="header-spacer"></div>
    
      <!-- Ïò§Î•∏Ï™Ω Î¨∂Ïùå: ÌÉúÍ∑∏ + ÏÑ§Ï†ï ÏïÑÏù¥ÏΩò -->
      <!-- Ìó§Îçî ÎÇ¥Î∂Ä Ïò§Î•∏Ï™Ω ÏòÅÏó≠Îßå ÍµêÏ≤¥ -->
      <div class="header-right">
        <div class="header-tags">
          <span
            v-if="profile.division"
            class="tag tag-division clickable"
            title="Íµ¨Î∂Ñ"
            role="button" tabindex="0"
            @click="onDivisionTagClick"
            @keydown.enter.prevent="onDivisionTagClick"
            @keydown.space.prevent="onDivisionTagClick"
          >
            <i class="dot"></i>[{{ profile.division }}] {{ profile.job }}
          </span>
          <!--<span
            v-if="profile.job"
            class="tag tag-job clickable"
            title="ÏßÅÏóÖ"
            role="button" tabindex="0"
            @click="onJobTagClick"
            @keydown.enter.prevent="onJobTagClick"
            @keydown.space.prevent="onJobTagClick"
          >
            <i class="dot"></i>{{ profile.job }}
          </span>-->
        </div>
      
        <!-- ‚öô ÎåÄÏã† ÏïÑÎ∞îÌÉÄ Î≤ÑÌäº -->
        <button
          type="button"
          class="header-avatar-btn"
          @click="onSettingsClick"
          aria-label="ÌîÑÎ°úÌïÑ ÏÑ§Ï†ï Ïó¥Í∏∞"
        >
          <template v-if="profile.avatar">
            <img :src="profile.avatar" alt="ÌîÑÎ°úÌïÑ Ïù¥ÎØ∏ÏßÄ" class="header-avatar-img" />
          </template>
          <template v-else>
            <span class="header-avatar-fallback">{{ initials }}</span>
          </template>
        </button>
      </div>

    </div>

    <!-- Î©îÏãúÏßÄ ÏòÅÏó≠ -->
    <div class="chat-messages" ref="messagesContainer">
      <div
        v-for="(msg, index) in messages"
        :key="index"
        :class="['chat-bubble', msg.role]"
      >
        <div class="avatar">
          <span v-if="msg.role === 'user'">üôã</span>
        </div>

        <div class="bubble-content">
          <!-- Ï≤®Î∂Ä(Î©îÏãúÏßÄ Î≤ÑÎ∏î ÎÇ¥Î∂Ä) -->
          <div v-if="msg.attachments && msg.attachments.length" class="bubble-attachments">
            <div v-for="(att, i) in msg.attachments" :key="i" class="bubble-attachment">
              <template v-if="att.kind==='image'">
                <img :src="att.src" :alt="att.name" />
              </template>
              <template v-else>
                <span class="file-emoji">{{ att.emoji }}</span>
                <span class="file-label" :title="att.name">{{ att.name }}</span>
              </template>
            </div>
          </div>

          <!-- ÌÖçÏä§Ìä∏ -->
          <template v-if="msg.loading">
             <span v-if="msg.loadingText" class="loading-label">{{ msg.loadingText }}</span>
             <span class="typing-indicator">
               <span class="dot"></span><span class="dot"></span><span class="dot"></span>
             </span>
           </template>
           <span v-else v-html="safeFormat(msg.text)"></span>
        </div>
      </div>
    </div>

    <!-- ‚ú® ÏûëÏÑ± Ï§ë Ï≤®Î∂Ä ÎØ∏Î¶¨Î≥¥Í∏∞(Ï†ÑÏÜ° Ï†Ñ, ÏûÖÎ†•Ï∞Ω ÏúÑ Í≥†Ï†ï) -->
    <div v-if="uploadedFiles.length" class="compose-preview-container">
      <div v-for="(file, index) in uploadedFiles" :key="index" class="compose-preview-item">
        <div v-if="file.type.startsWith('image/')" class="image-preview">
          <img :src="previewURLs[index]" alt="ÎØ∏Î¶¨Î≥¥Í∏∞" />
        </div>
        <div v-else class="file-icon">
          <span>{{ fileEmoji(file.name) }}</span>
          <span class="file-name" :title="file.name">{{ file.name }}</span>
        </div>
        <button class="remove-file" @click="removeFile(index)" aria-label="Ï≤®Î∂Ä ÏÇ≠Ï†ú">‚úñ</button>
      </div>
    </div>
    <!-- ‚ú® Ï∂îÏ≤ú ÎßêÌíçÏÑ† (ÏûÖÎ†•Ï∞Ω ÏúÑ Í≥†Ï†ï) -->
    <div
      v-if="showInitPrompts"
      class="suggested-prompts initial"
      :class="{ expanded: initExpanded }"
    >
      <!-- ‚úÖ Ïπ© Î™©Î°ù (1Ï§Ñ/2Ï§Ñ ÌÜ†Í∏ÄÏóê Îî∞Îùº shownInitItems ÏÇ¨Ïö©) -->
      <button
        v-for="(p, i) in shownInitItems"
        :key="'init-'+i"
        type="button"
        class="chip chip-2line chip-with-icon"
        @click="onInitChipClick(p)"
      >
        <div class="chip-body">
          <!-- ÏïÑÏù¥ÏΩòÍ≥º ÌÉÄÏù¥ÌãÄ Ìïú Ï§Ñ -->
          <div class="chip-title-with-icon">
            <span class="chip-icon" aria-hidden="true">
              {{ emojiIcon(p.title) }} 
            </span>
            <span class="chip-title">{{ p.title }}</span>
          </div>
          <div class="chip-desc">{{ p.desc }}</div>
        </div>
      </button>
    
      <!-- Îçî Î≥¥Í∏∞ / Ï†ëÍ∏∞ -->
      <button
        type="button"
        class="chip chip-2line chip-more"
        :aria-pressed="initExpanded ? 'true' : 'false'"
        @click.stop="toggleInitExpand()"   
      >
        <div class="chip-title">{{ initExpanded ? 'Ï†ëÍ∏∞' : 'Îçî Î≥¥Í∏∞' }}</div>
        <div class="chip-desc">{{ initExpanded ? 'Ìïú Ï§ÑÎ°ú' : '2Ï§Ñ Î≥¥Í∏∞' }}</div>
      </button>
    </div>
    
    <!-- ‚úÖ ÎãµÎ≥Ä ÌõÑ ÌõÑÏÜç Ï†úÏïà(Ìïú Ï§Ñ Ïπ©) -->
    <div v-else-if="showFollowupPrompts" class="suggested-prompts">
      <button
        type="button"
        class="chip chip-reset"
        title="Ï¥àÍ∏∞ ÏßàÎ¨∏ÏúºÎ°ú ÎèåÏïÑÍ∞ÄÍ∏∞"
        @click="resetToInitPrompts"
      >
        <!-- lucide rotate-ccw ÏïÑÏù¥ÏΩò -->
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="16"
          height="16"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
          class="lucide lucide-rotate-ccw"
        >
          <path d="M3 2v6h6"></path>
          <path d="M3 13a9 9 0 1 0 3-7.7L3 8"></path>
        </svg>
      </button>
      <button
        v-for="(p, i) in suggestedPrompts"
        :key="'sug-'+i"
        type="button"
        class="chip"
        @click="applySuggestion(p, { send: true })"
        title="ÌÉ≠: Î∞îÎ°ú Ï†ÑÏÜ°"
      >
        {{ p }}
      </button>
    </div>
    <!-- ‚è≥ Î°úÎî© Ïπ© -->
    <div v-else-if="showFollowupLoading" class="suggested-prompts">
      <div class="chip chip-loading" aria-live="polite" aria-busy="true">
        <span>ÌõÑÏÜç ÏßàÎ¨∏ ÏÉùÏÑ± Ï§ë</span>
        <span class="loading-dots"><span class="dot"></span><span class="dot"></span><span class="dot"></span></span>
      </div>
    </div>
    <!-- ÏûÖÎ†• ÏòÅÏó≠ -->
    <form class="chat-input-container" :class="{ dragover: isDragOver }" @submit.prevent>
      <button
        type="button"
        class="upload-button"
        aria-label="ÌååÏùº ÏóÖÎ°úÎìú"
        @click.stop="togglePicker"
        :disabled="isSending"
      >
        <!-- ...svg... -->

        <!-- ÌîåÎü¨Ïä§ ÏïÑÏù¥ÏΩò -->
        <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="#555" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="12" y1="5" x2="12" y2="19" />
          <line x1="5" y1="12" x2="19" y2="12" />
        </svg>
      </button>
      
      <!-- ÏûëÏùÄ ÏÑ†ÌÉù Î©îÎâ¥ -->
      <div
        v-if="pickerOpen"
        class="picker-menu"
        v-click-outside="closePicker"  
        @click.stop="noop"             
      >
        <button type="button" class="picker-item" @click="openPicker('docs')">üìÑ Î¨∏ÏÑú ÏóÖÎ°úÎìú</button>
        <button type="button" class="picker-item" @click="openPicker('images')">üñº ÏÇ¨ÏßÑ ÏóÖÎ°úÎìú</button>
      </div>
      
      <!-- Î¨∏ÏÑú Ï†ÑÏö© input -->
      <input
        id="file-input-docs"
        ref="fileInputDocs"
        type="file"
        style="display:none"
        @change="onPickedFiles"
        multiple
        accept="
          application/pdf,
          text/plain,
          application/msword,
          application/vnd.openxmlformats-officedocument.wordprocessingml.document,
          application/vnd.ms-excel,
          application/vnd.openxmlformats-officedocument.spreadsheetml.sheet
        "
      />
      
      <!-- Ïù¥ÎØ∏ÏßÄ Ï†ÑÏö© input -->
      <input
        id="file-input-images"
        ref="fileInputImages"
        type="file"
        style="display:none"
        @change="onPickedFiles"
        multiple
        accept="image/*"
      />

      <textarea
        id="chat-message"
        name="message"
        autocomplete="off"
        v-model="userInput"
        ref="chatInput"
        class="chat-textarea"
        placeholder="Î¨¥ÏóáÏù¥Îì† Î¨ºÏñ¥Î≥¥ÏÑ∏Ïöî..."
        rows="1"
        @input="autoResize"
        @keydown="onKeydown"
        @compositionstart="onCompositionStart"
        @compositionend="onCompositionEnd"
      ></textarea>

      <button
        type="button"
        class="send-button"
        :disabled="!canSend || isSending"
        aria-label="Î©îÏãúÏßÄ Ï†ÑÏÜ°"
        @click="sendMessage"
      >
        <svg viewBox="0 0 24 24" fill="white" width="18" height="18" aria-hidden="true">
          <path d="M2 21l21-9L2 3v7l15 2-15 2v7z" />
        </svg>
      </button>
    </form>
    <show-analysis-sheet
      v-if="showAnalysisSheet"
      :uploaded-files="uploadedFiles"
      :is-sending="isSending"
      :file-emoji="fileEmoji"
      @close="showAnalysisSheet=false"
      @remove-index="removeFile"
      @select-files="(files)=>handleFileUpload({ target: { files } })"
      @send="onAnalysisSend"
    />
  </div>

  <!-- ‚úÖ ÏÑ§Ï†ï ÎìúÎ°úÏñ¥: Ïò§Î•∏Ï™Ω ‚Üí ÏôºÏ™Ω Ïä¨ÎùºÏù¥Îìú (Vulk ÌÜ§) -->
  <transition name="aa-slide">
    <div v-if="showSettingsModal" class="aa-modal-backdrop" @click.self="closeSettings" role="presentation">
      <div
        class="aa-drawer"
        ref="drawer"
        role="dialog"
        aria-modal="true"
        :aria-labelledby="'drawerTitle'"
      >
        <!-- Ìó§Îçî(Í∑∏ÎùºÎîîÏñ∏Ìä∏ Ïï±Î∞î + ÌûàÏñ¥Î°ú) -->
        <header class="drawer-header">
          <div class="drawer-appbar">
            <button type="button" class="icon-btn" aria-label="Îã´Í∏∞" @click="closeSettings">‚Üê</button>
            <h2 id="drawerTitle" class="drawer-title">ÌîÑÎ°úÌïÑ ÏÑ§Ï†ï</h2>
            <span class="icon-btn-spacer" aria-hidden="true"></span>
          </div>
          <div class="drawer-hero">
            <button type="button" class="avatar-lg-btn" @click="triggerAvatarPick" aria-label="ÌîÑÎ°úÌïÑ Ïù¥ÎØ∏ÏßÄ Î≥ÄÍ≤Ω">
              <img v-if="profile.avatar" :src="profile.avatar" alt="ÌîÑÎ°úÌïÑ Ïù¥ÎØ∏ÏßÄ" class="avatar-lg-img" />
              <span v-else class="avatar-lg-fallback">{{ initials }}</span>
            </button>
            <p class="drawer-subtitle">Í≥†Í∞ù ÏùëÎåÄÏóê ÏÇ¨Ïö©ÎêòÎäî Í∏∞Î≥∏ Ï†ïÎ≥¥Î•º ÏÑ§Ï†ïÌïòÏÑ∏Ïöî.</p>
            <!-- Ïà®ÍπÄ ÌååÏùº ÏûÖÎ†• -->
            <input ref="avatarInput" type="file" accept="image/*" style="display:none" @change="onAvatarSelected" />
          </div>
        </header>

        <!-- Î≥∏Î¨∏ -->
        <section class="drawer-body" :aria-labelledby="'sec-account'">
          <!-- ÏÑπÏÖò: Í≥ÑÏ†ï Ï†ïÎ≥¥ -->
          <h3 id="sec-account" class="sec-title">Í≥ÑÏ†ï Ï†ïÎ≥¥</h3>
          <div class="form-grid">
            <label class="field" for="profile-name">
              <span class="label">Ïù¥Î¶Ñ</span>
              <div class="input-wrap">
                <i class="fi">üë§</i>
                <input
                  id="profile-name"
                  name="name"
                  autocomplete="name"
                  v-model.trim="profile.name"
                  type="text"
                  placeholder="ÌôçÍ∏∏Îèô"
                />
              </div>
              <small class="hint">Î™ÖÌï®/Í≥ÑÏïΩÏÑú ÌëúÍ∏∞ÏôÄ ÎèôÏùºÌïòÍ≤å ÏûÖÎ†•</small>
            </label>

            <label class="field" for="profile-email">
              <span class="label">Ïù¥Î©îÏùº</span>
              <div class="input-wrap">
                <i class="fi">‚úâ</i>
                <input
                  id="profile-email"
                  name="email"
                  autocomplete="email"
                  v-model.trim="profile.email"
                  type="email"
                  placeholder="you@company.com"
                />
              </div>
              <small class="hint">ÏïåÎ¶º Î∞úÏÜ° Î∞è Î°úÍ∑∏Ïù∏Ïóê ÏÇ¨Ïö©</small>
            </label>
          </div>

          <!-- ÏÑπÏÖò: Ïó∞ÎùΩÏ≤ò -->
          <h3 class="sec-title" id="sec-contact">Ïó∞ÎùΩÏ≤ò</h3>
          <label class="field" for="profile-phone">
            <span class="label">Ï†ÑÌôîÎ≤àÌò∏</span>
            <div class="input-wrap">
              <i class="fi">üìû</i>
              <input
                id="profile-phone"
                name="tel"
                autocomplete="tel"
                :value="profile.phone"
                @input="onPhoneInput"
                type="tel"
                inputmode="numeric"
                placeholder="010-0000-0000"
              />
            </div>
            <small class="hint">Ïà´ÏûêÎßå ÏûÖÎ†•Ìï¥ÎèÑ ÏûêÎèôÏúºÎ°ú ÌïòÏù¥Ìîà Ï≤òÎ¶¨ÎèºÏöî</small>
          </label>

          <!-- ÏÑπÏÖò: ÏóÖÎ¨¥ ÏÜçÏÑ± -->
          <h3 class="sec-title" id="sec-role">ÏóÖÎ¨¥ ÏÜçÏÑ±</h3>
          <div class="pill-group" role="radiogroup" aria-labelledby="sec-role">
            <div
              class="pill-group"
              ref="divisionField"
              role="radiogroup"
              aria-labelledby="sec-role"
            >
              <label
                v-for="opt in divisions"
                :key="opt"
                class="pill"
                :class="{ active: profile.division === opt }"
                :for="`division-${opt}`"
                :aria-checked="profile.division === opt"
                role="radio"
                tabindex="0"
                @keydown.enter.prevent="profile.division = opt"
                @keydown.space.prevent="profile.division = opt"
              >
                <input
                  class="vh"
                  :id="`division-${opt}`"
                  type="radio"
                  name="division"
                  :value="opt"
                  v-model="profile.division"
                />
                <span class="pill-text">{{ opt }}</span>
              </label>
            </div>
          </div>

          <label class="field" for="profile-job">
            <span class="label">ÏßÅÏóÖ</span>
            <div class="input-wrap">
              <i class="fi">üíº</i>
              <input
                id="profile-job"
                ref="jobField"
                name="organization-title"
                autocomplete="organization-title"
                v-model.trim="profile.job"
                type="text"
                list="job-suggestions"
                placeholder="Î≥¥ÌóòÏÑ§Í≥ÑÏÇ¨"
              />
              <datalist id="job-suggestions">
                <option v-for="s in jobSuggestions" :key="s" :value="s" />
              </datalist>
            </div>
            <small class="hint">Ïòà: Î≥¥ÌóòÏÑ§Í≥ÑÏÇ¨ / ÏÜêÌï¥ÏÇ¨Ï†ïÏÇ¨ / GA ÏÑ§Í≥ÑÏÇ¨‚Ä¶</small>
          </label>
        </section>

        <!-- ÌïòÎã® Í≥†Ï†ï Ïï°ÏÖò -->
        <footer class="drawer-footer">
          <button class="btn ghost" type="button" @click="closeSettings">Ï∑®ÏÜå</button>
          <button class="btn primary" type="button" @click="saveSettings">Ï†ÄÏû•</button>
        </footer>

        <!-- Ïπ¥ÌÖåÍ≥†Î¶¨ ÎØ∏Î¶¨Î≥¥Í∏∞ -->
        <p class="hint center pv-12">
          Ï†ÑÏÜ° Ïãú <code>category</code>Ïóê<br />
          <strong>{{ previewCategoryString }}</strong> Î°ú Ìè¨Ìï®Îê©ÎãàÎã§.
        </p>
      </div>
    </div>
  </transition>
</template>

<script>
/**
 * Vue 3 SFC
 * npm i dompurify
 */
import DOMPurify from "dompurify";
import MarkdownIt from "markdown-it";
import ShowAnalysisSheet from "@/components/AnalysisSheet.vue";

const clickOutside = {
  beforeMount(el, binding) {
    el.__clickOutside__ = (e) => {
      if (!(el === e.target || el.contains(e.target))) {
        binding.value(e);
      }
    };
    setTimeout(() => {
      document.addEventListener("click", el.__clickOutside__);
    }, 0);
  },
  unmounted(el) {
    document.removeEventListener("click", el.__clickOutside__);
  }
};

export default {
  name: "ChatAA",
  directives: { clickOutside },
  components: { ShowAnalysisSheet },
  data() {
    return {
      userInput: "",
      messages: [],
      sessionId: null,
      lastFileName: "",

      // ÏûëÏÑ± Ï§ë Ï≤®Î∂Ä(Ï†ÑÏÜ° Ï†Ñ)
      uploadedFiles: [],
      previewURLs: [],
      isDragOver: false,
      isDraggingFile: false,
      dragCounter: 0,

      errorMessage: "",
      isSending: false,
      isComposing: false,
      abortController: null,
      forceInitPrompts: false,
      showAnalysisSheet: false,

      // ‚úÖ ÌîÑÎ°úÌïÑ ÏÉÅÌÉú(Î°úÏª¨ Ï†ÄÏû•/Î°úÎìú)
      profile: {
        name: "",
        email: "",
        phone: "",
        division: "",
        job: "",
        avatar: ""          // ‚Üê Ï∂îÍ∞Ä: dataURL Ï†ÄÏû•
      },
      divisions: ["ÏòÅÏóÖ", "ÏßÄÏõê", "ÍµêÏú°", "Ï†ïÎ≥¥"],
      jobSuggestions: ["Î≥¥ÌóòÏÑ§Í≥ÑÏÇ¨", "ÏÜêÌï¥ÏÇ¨Ï†ïÏÇ¨", "GA ÏÑ§Í≥ÑÏÇ¨", "Ïñ∏ÎçîÎùºÏù¥ÌÑ∞", "ÏΩúÏÑºÌÑ∞ ÏÉÅÎã¥ÏÇ¨"],
      showSettingsModal: false,
      pickerOpen: false, // ‚Üê Ï∂îÍ∞Ä: ÏóÖÎ°úÎìú Ï¢ÖÎ•ò ÏÑ†ÌÉù Î©îÎâ¥ Ïò§Ìîà ÏÉÅÌÉú

      // ÏÑ§Ï†ï
      API_BASE: "http://15.165.60.45:5000",
      LIMIT_MAX_FILES: 3,
      LIMIT_PER_FILE: 10 * 1024 * 1024,
      LIMIT_TOTAL: 25 * 1024 * 1024,
      initExpanded: false, // ‚úÖ Ï¥àÍ∏∞ Ïπ© ÌôïÏû• ÏÉÅÌÉú(Îçî Î≥¥Í∏∞)
      isAwaitingFollowups: false, // Ï∂îÍ∞ÄÏßàÎ¨∏ API ÏùëÎãµ ÎåÄÍ∏∞ ÏÉÅÌÉú
      suggestedPrompts: [],            // ÏùëÎãµ ÌõÑ Ìïú Ï§Ñ Ïπ©
      suggestedPromptsInitial: [
        { title: "Î¨∏ÏÑúÍ≥µÏú†", desc: "Í≥†Í∞ù Ïã§ÏãúÍ∞Ñ ÏÉÅÎã¥" },
        { title: "Î≥¥Ïû•Î∂ÑÏÑù", desc: "Í≥ÑÏïΩ Î≥¥Ïû• ÎÇ¥Ïö© Î∂ÑÏÑù" },
        { title: "Ï†úÏïàÏÑúÏûëÏÑ±", desc: "Ïö∞ÏÑ†ÏàúÏúÑ Ï∂îÏ≤ú Ï†úÏïàÏÑú ÏÉùÏÑ±" },
        { title: "ÏïàÎÇ¥Î¨∏ÏûëÏÑ±", desc: "ÌõÑÏÜç ÏïàÎÇ¥Î¨∏¬∑ÌÜ° Î∞úÏÜ°" },
        { title: "ÍµêÏú°ÏûêÎ£å", desc: "ÏÉÅÎã¥¬∑ÏòÅÏóÖ ÍµêÏú°ÏûêÎ£å Ï†úÏûë" },
        { title: "Ïä§ÏºÄÏ§ÑÏûëÏÑ±", desc: "ÏóÖÎ¨¥¬∑ÏÉÅÎã¥ ÏùºÏ†ï Í≥ÑÌöç" },
        { title: "ÏÉÅÎã¥Ïä§ÌÅ¨Î¶ΩÌä∏", desc: "Î∞©Î¨∏¬∑ÏΩú ÏÉÅÎã¥ ÎåÄÎ≥∏ ÏÉùÏÑ±" },
        { title: "ÎßàÏºÄÌåÖÏΩòÌÖêÏ∏†", desc: "ÌôçÎ≥¥¬∑ÎßàÏºÄÌåÖ Í∏Ä/Ïù¥ÎØ∏ÏßÄ Ï†úÏûë" },
        { title: "FAQ¬∑ÏÉÅÎã¥Î≥¥Ï°∞", desc: "ÏûêÏ£º Î¨ªÎäî ÏßàÎ¨∏/Î≥¥Ï°∞ ÎãµÎ≥Ä" },
        { title: "ÏÑ±Í≥µÏú®Ï∏°Ï†ï", desc: "Í≥ÑÏïΩ ÏÑ±Í≥µÎ•† Î∂ÑÏÑù¬∑Í∞úÏÑ†" },
        { title: "ÏòàÏÉÅÏàòÏàòÎ£å", desc: "Í≥ÑÏïΩ ÏòàÏÉÅ ÏàòÏàòÎ£å Í≥ÑÏÇ∞" },
        { title: "Î≥¥ÏÉÅÎã¥Î≥¥ÏòàÏÉÅ", desc: "Î≥¥ÌóòÍ∏à¬∑Îã¥Î≥¥Í∏à ÏòàÏÉÅ" },
        { title: "Î™®Î∞îÏùºÏø†Ìè∞", desc: "Í≥†Í∞ù ÎåÄÏÉÅ ÏÑ†Î¨º Ï†ÑÏÜ°" }
      ]
    };
  },
  created() {
    // ÎßàÌÅ¨Îã§Ïö¥ ÌååÏÑú: ÌÖåÏù¥Î∏î/Í∞úÌñâ/ÎßÅÌÅ¨ ÌôúÏÑ±Ìôî
    this._md = new MarkdownIt({
      html: false,     // ÎßàÌÅ¨Îã§Ïö¥ ÏïàÏóêÏÑú ÏûÑÏùòÏùò HTML Í∏àÏßÄ (Î≥¥Ïïà)
      linkify: true,   // URL ÏûêÎèô ÎßÅÌÅ¨
      breaks: true     // Í∞úÌñâÏùÑ <br>Î°ú
    }).enable(['table']); // GFM Ìëú ÏßÄÏõê
  },
  computed: {
    canSend() {
      return (this.userInput.trim().length > 0) || (this.uploadedFiles.length > 0);
    },
    previewCategoryString() {
      return this.buildCategoryMetaString();
    },
    // Ïù¥ÎãàÏÖú ÏïÑÎ∞îÌÉÄ ÌÖçÏä§Ìä∏
    initials() {
      const n = (this.profile.name || "").trim();
      if (!n) return "U";
      // Í≥µÎ∞± Í∏∞Ï§Ä Ïïû Í∏ÄÏûê 2Í∞ú Ï°∞Ìï©
      const parts = n.split(/\s+/).filter(Boolean);
      const first = parts[0]?.[0] || "";
      const second = parts[1]?.[0] || "";
      return (first + second).slice(0, 2).toUpperCase();
    },
    initFirstLineCount() { return 2; },
    shownInitItems() {
      return this.initExpanded
        ? this.suggestedPromptsInitial
        : this.suggestedPromptsInitial.slice(0, this.initFirstLineCount);
    },
    hasFiles() {
      return this.uploadedFiles.length > 0;
    },
    showInitPrompts() {
      return !this.hasFiles &&
      !this.isAwaitingFollowups &&
      (this.forceInitPrompts || this.messages.length === 0) &&   // üîπ Í∞ïÏ†ú ÌëúÏãú ÌóàÏö©
      this.suggestedPromptsInitial.length > 0
    },
    showFollowupPrompts() {
      return !this.hasFiles &&
      !this.isAwaitingFollowups &&
      !this.forceInitPrompts &&        // üîπ Í∞ïÏ†ú Ï¥àÍ∏∞ Î™®ÎìúÏùº Îïê ÌõÑÏÜç Ïπ© Ïà®ÍπÄ
      this.messages.length > 0 &&
      this.suggestedPrompts.length > 0
    },
    showFollowupLoading() {
      return !this.hasFiles && this.isAwaitingFollowups;
    }
  },
  mounted() {
    // drag global
    window.addEventListener("dragenter", this.onDragEnter);
    window.addEventListener("dragleave", this.onDragLeave);
    window.addEventListener("dragover", this.onDragOver);
    window.addEventListener("drop", this.onDrop);

    // viewport/blur ÏïàÏ†ÑÏû•Ïπò
    this._vvHandler = () => this.scrollToBottom();
    if (window.visualViewport) window.visualViewport.addEventListener("resize", this._vvHandler);

    this._blurHandler = () => { this.dragCounter = 0; this.isDraggingFile = false; };
    window.addEventListener("blur", this._blurHandler);
    document.addEventListener("visibilitychange", this._blurHandler);

    this._leaveWindow = (e) => {
      if (e.clientX <= 0 || e.clientY <= 0 ||
          e.clientX >= window.innerWidth || e.clientY >= window.innerHeight) {
        this.dragCounter = 0;
        this.isDraggingFile = false;
      }
    };
    const cm = this.$refs.messagesContainer;
    if (cm) {
      cm.addEventListener('touchmove', (e) => {
        e.stopPropagation();
        // ÌïÑÏöîÌïòÎ©¥ Îã§Ïùå Ï§ÑÎèÑ ÌôúÏÑ±Ìôî (ÌéòÏù¥ÏßÄ Ï†ÑÏ≤¥ ÎÅåÎ¶¨Îäî ÌòÑÏÉÅ Í∞ïÏ†ú Ï∞®Îã®)
        // e.preventDefault();
      }, { passive: false });
    }
    window.addEventListener("mouseout", this._leaveWindow);

    // ‚úÖ ÌîÑÎ°úÌïÑ Î°úÎìú
    this.loadSettings();
  },
  beforeUnmount() {
    window.removeEventListener("dragenter", this.onDragEnter);
    window.removeEventListener("dragleave", this.onDragLeave);
    window.removeEventListener("dragover", this.onDragOver);
    window.removeEventListener("drop", this.onDrop);

    if (window.visualViewport && this._vvHandler) {
      window.visualViewport.removeEventListener("resize", this._vvHandler);
    }
    window.removeEventListener("blur", this._blurHandler);
    document.removeEventListener("visibilitychange", this._blurHandler);
    window.removeEventListener("mouseout", this._leaveWindow);

    this.clearAllPreviews();
    // ÌÇ§ Ìï∏Îì§Îü¨ Ï†úÍ±∞
    document.removeEventListener("keydown", this._escHandler);
  },
  methods: {
    colorizeStatus(root) {
      const skipTags = new Set(['CODE', 'PRE', 'A', 'SCRIPT', 'STYLE', 'TEXTAREA']);
      const walker = document.createTreeWalker(root, NodeFilter.SHOW_TEXT, {
        acceptNode(node) {
          if (!node.nodeValue) return NodeFilter.FILTER_REJECT;
          const parent = node.parentElement;
          if (!parent) return NodeFilter.FILTER_REJECT;
          if (skipTags.has(parent.tagName)) return NodeFilter.FILTER_REJECT;
          if (!/Ï∂©Î∂Ñ|Î∂ÄÏ°±/.test(node.nodeValue)) return NodeFilter.FILTER_REJECT;
          return NodeFilter.FILTER_ACCEPT;
        }
      });
    
      const targets = [];
      while (walker.nextNode()) targets.push(walker.currentNode);
    
      for (const tn of targets) {
        const frag = document.createDocumentFragment();
        const parts = tn.nodeValue.split(/(Ï∂©Î∂Ñ|Î∂ÄÏ°±)/g);
        for (const p of parts) {
          if (p === 'Ï∂©Î∂Ñ') {
            const span = document.createElement('span');
            span.className = 'enough';
            span.textContent = p;
            frag.appendChild(span);
          } else if (p === 'Î∂ÄÏ°±') {
            const span = document.createElement('span');
            span.className = 'lack';
            span.textContent = p;
            frag.appendChild(span);
          } else if (p) {
            frag.appendChild(document.createTextNode(p));
          }
        }
        tn.parentNode.replaceChild(frag, tn);
      }
    },
    onAnalysisSend(payload) {
      const m = payload && typeof payload.memo === 'string' ? payload.memo.trim() : '';
      if (m) this.userInput = m;        // ‚úÖ Î®ºÏ†Ä userInput Ï±ÑÏö∞Í≥†
      this.showAnalysisSheet = false;
      this.sendMessage();               // ‚úÖ Í∑∏ Îã§Ïùå Ï†ÑÏÜ°
    },
    onInitChipClick(p) {
      const title = (p?.title || "").trim();
      this.lastClickedChipTitle = title;
      if (title === "Î≥¥Ïû•Î∂ÑÏÑù") {
        this.showAnalysisSheet = true;
        return;
      }
      this.applySuggestion(`${p.title} ${p.desc}`, { send: true });
    },
    resetToInitPrompts() {
      this.suggestedPrompts = [];    // ÌõÑÏÜç Ïπ© Ï†úÍ±∞
      this.isAwaitingFollowups = false;
      this.initExpanded = false;
      this.forceInitPrompts = true;  // üîπ Ï¥àÍ∏∞ ÏßàÎ¨∏ Î™®Îìú Í∞ïÏ†ú
      this.$nextTick(this.scrollToBottom);
    },
    togglePicker() {
      this.pickerOpen = !this.pickerOpen;
    },
    closePicker() {
      this.pickerOpen = false;
    },
    emojiIcon(title) {
      const map = {
        "Î¨∏ÏÑúÍ≥µÏú†": "üìÑ",
        "Î≥¥Ïû•Î∂ÑÏÑù": "üîç",
        "Ï†úÏïàÏÑúÏûëÏÑ±": "‚úçÔ∏è",
        "ÏïàÎÇ¥Î¨∏ÏûëÏÑ±": "üì§",
        "ÍµêÏú°ÏûêÎ£å": "üë®‚Äçüè´",
        "Ïä§ÏºÄÏ§ÑÏûëÏÑ±": "üìÖ",
        "ÏÉÅÎã¥Ïä§ÌÅ¨Î¶ΩÌä∏": "üí¨",
        "ÎßàÏºÄÌåÖÏΩòÌÖêÏ∏†": "üì¢",
        "FAQ¬∑ÏÉÅÎã¥Î≥¥Ï°∞": "‚ùì",
        "ÏÑ±Í≥µÏú®Ï∏°Ï†ï": "üìà",
        "ÏòàÏÉÅÏàòÏàòÎ£å": "üí∞",
        "Î≥¥ÏÉÅÎã¥Î≥¥ÏòàÏÉÅ": "üõ°Ô∏è",
        "Î™®Î∞îÏùºÏø†Ìè∞": "üéÅ"
      };
      return map[title] || "üß©";
    },
    noop(){}, // Ïù¥Î≤§Ìä∏ Ìï∏Îì§Îü¨ ÏûêÎ¶¨ Ï±ÑÏö∞Í∏∞
    // ------ Í≥µÌÜµ ------
    generateSessionId() {
      return "sess-" + Math.random().toString(36).slice(2, 11);
    },
    showError(msg) {
      this.errorMessage = msg;
      setTimeout(() => (this.errorMessage = ""), 4000);
    },
    _applyFollowups(arr) {
      let out = Array.isArray(arr) ? arr : [];
      out = out
        .filter(v => typeof v === "string")
        .map(v => v.trim())
        .filter(Boolean);
    
      // Ï§ëÎ≥µ Ï†úÍ±∞
      out = [...new Set(out)];
    
      if (out.length >= 3 && out.length <= 6) {
        this.suggestedPrompts = out;
      } else {
        throw new Error("3~6Í∞ú JSON Î∞∞Ïó¥ ÏïÑÎãò");
      }
    },
    toggleInitExpand() {
      this.initExpanded = !this.initExpanded;
    },
    // ÏóÖÎ°úÎìú ÏÑ†ÌÉù Î©îÎâ¥ÏóêÏÑú Ìò∏Ï∂ú (Î¨∏ÏÑú/Ïù¥ÎØ∏ÏßÄ)
    openPicker(kind = "docs") {
      this.pickerOpen = false;
      if (kind === "images") this.$refs.fileInputImages?.click();
      else this.$refs.fileInputDocs?.click();
    },
  
    // Ïà®ÍπÄ inputÏóêÏÑú ÌååÏùº ÏÑ†ÌÉùÏù¥ ÎÅùÎÇòÎ©¥ Í∏∞Ï°¥ handleFileUpload Ïû¨ÌôúÏö©
    onPickedFiles(e) {
      try {
        this.handleFileUpload(e);
      } catch (err) {
        console.error("ÌååÏùº ÏóÖÎ°úÎìú Ï§ë Ïò§Î•ò Î∞úÏÉù:", err);
      } finally {
        // Í∞ôÏùÄ ÌååÏùº Îã§Ïãú Í≥†Î•º Ïàò ÏûàÍ≤å value Î¶¨ÏÖã
        e.target.value = "";
      }
    },
    
    scrollToBottom() {
      this.$nextTick(() => {
        const container = this.$refs.messagesContainer;
        if (container) {
          setTimeout(() => { container.scrollTop = container.scrollHeight; }, 40);
        }
      });
    },
    /**
     * GPT ÏùëÎãµ Î¨∏ÏûêÏó¥ ‚Üí (1) ```html``` Î∏îÎ°ùÏùÄ Í∑∏ÎåÄÎ°ú sanitizeÌï¥ÏÑú ÏÇΩÏûÖ
     *                 ‚Üí (2) ÎÇòÎ®∏ÏßÄÎäî Markdown-itÏúºÎ°ú Î†åÎçî(Ìëú Ìè¨Ìï®) ÌõÑ sanitize
     */
    safeFormat(text) {
      if (!text) return "";
    
      // 0) Í∞úÌñâ/Í≥µÎ∞± Ï†ïÎ¶¨
      text = String(text).replace(/\r\n?/g, "\n");
      // ÏßÄÎÇòÏπú Îπà Ï§ÑÏùÄ 1Ï§ÑÎ°ú Ï∂ïÏÜå(Ìëú Í≤ΩÍ≥Ñ Î≥¥Í∞ï Ï†ÑÏóê Í≥ºÎèÑÌïú Í∞úÌñâ Ï†úÍ±∞)
      text = text.replace(/\n{3,}/g, "\n\n");
    
      // 1) Ìëú Í≤ΩÍ≥Ñ Î≥¥Í∞ï: "Ìëú ÎßàÏßÄÎßâ Ìñâ" Îã§Ïùå Ï§ÑÏù¥ ÌëúÍ∞Ä ÏïÑÎãàÎ©¥ Îπà Ï§Ñ 1Í∞ú Í∞ïÏ†ú ÏÇΩÏûÖ
      // 1-1) GFM ÌååÏù¥ÌîÑ ÌÖåÏù¥Î∏î(|Î°ú ÏãúÏûëÌïòÎäî ÌñâÎì§)
      //      - ÎßàÏßÄÎßâ Ìñâ(Îã§Ïùå Ï§ÑÏù¥ | Î°ú ÏãúÏûëÌïòÏßÄ ÏïäÎäî Í≤ΩÏö∞)ÏùÑ Î∞úÍ≤¨ÌïòÎ©¥ Í∑∏ Îí§Ïóê Îπà Ï§Ñ Ï∂îÍ∞Ä
      text = text.replace(/(\n\|[^\n]*\n)(?!\|)/g, "$1\n");
    
      // 1-2) TSV Ïä§ÌÉÄÏùº(ÌÉ≠ÏúºÎ°ú Íµ¨Î∂ÑÎêú Ïó∞ÏÜç ÌñâÎì§)ÎèÑ Í∞ôÏùÄ Î∞©ÏãùÏúºÎ°ú Î∂ÑÎ¶¨
      //      - ÎßàÏßÄÎßâ TSV Ìñâ(Îã§Ïùå Ï§ÑÏù¥ ÌÉ≠ Ìè¨Ìï® ÌñâÏù¥ ÏïÑÎãò) Îí§Ïóê Îπà Ï§Ñ Ï∂îÍ∞Ä
      text = text.replace(/(\n[^\n]*\t[^\n]*\n)(?![^\n]*\t)/g, "$1\n");
    
      text = text.replace(/(\n\|?\s*:?-{3,}.*\|\s*\n)(?!\|)/g, "$1\n");
    
      // 1-4) Ìëú Îã§ÏùåÏóê Î∞îÎ°ú ÌäπÏàò Î∂àÎ¶ø(üîπ, ‚úÖ Îì±)Ïù¥ Ïò§Î©¥ ÌôïÏã§Ìûà Î∂ÑÎ¶¨
      text = text.replace(/(\n\|[^\n]*\n)(?=\s*(?:üîπ|‚úÖ))/g, "$1\n");
    
      // 2) ÏÑ†/ÌõÑÌñâ Í≥µÎ∞± Î∞è Í≥ºÎèÑÌïú Îπà Ï§Ñ Ï†ïÎ¶¨(ÏµúÏ¢Ö)
      text = text.trim().replace(/\n{3,}/g, "\n\n");
    
      // 3) Sanitizer
      const sanitizeAll = (html) =>
        DOMPurify.sanitize(html, {
          ALLOWED_TAGS: [
            "div","p","br","strong","b","em","u","span","ul","ol","li","blockquote","code","pre",
            "table","thead","tbody","tr","th","td","caption","col","colgroup","hr","h1","h2","h3","h4","h5","h6","a"
          ],
          ALLOWED_ATTR: ["class","rowspan","colspan","align","width","href","title","target","rel"]
        });
    
      // 4) ```html ... ``` Î∏îÎ°ùÏùÄ ÏõêÏãú HTMLÎ°ú ÏÇ¥Î¶¨Í≥†, ÎÇòÎ®∏ÏßÄÎäî Markdown-it Î†åÎçî
      const re = /```html([\s\S]*?)```/gi;
      let out = "";
      let last = 0;
      let m;
    
      while ((m = re.exec(text)) !== null) {
        const before = text.slice(last, m.index);
        if (before) {
          const mdHtml = this._md.render(before);
          out += `<div class="md-block">${mdHtml}</div>`;
        }
        const rawHtml = (m[1] || "").trim();
        const safeHtml = sanitizeAll(rawHtml);
        out += `<div class="html-block">${safeHtml}</div>`;
        last = re.lastIndex;
      }
    
      const tail = text.slice(last);
      if (tail) {
        const mdHtml = this._md.render(tail);
        out += `<div class="md-block">${mdHtml}</div>`;
      }
    
      // 5) Ï∂úÎ†• ÎßêÎã®Ïùò Î∂àÌïÑÏöîÌïú <br>/Í≥µÎ∞± Ï†úÍ±∞ + ÏµúÏ¢Ö ÏÇ¥Í∑†
      out = out.replace(/(<br\s*\/?>|\s)+$/i, "");
      out = out.replace(/(<table[\s\S]*?<\/table>)/gi, '<div class="table-scroll">$1</div>');
      return sanitizeAll(out);
    },
    autoResize(e) {
      const el = e?.target || this.$refs.chatInput;
      if (!el) return;
      el.style.height = "auto";
      el.style.height = Math.min(el.scrollHeight, 200) + "px";
    },

    // ------ ÌÇ§ ÏûÖÎ†• ------
    onCompositionStart() { this.isComposing = true; },
    onCompositionEnd() { this.isComposing = false; },
    onKeydown(e) {
      const isMobile = /Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
      if (isMobile) return;
      if (e.key === "Enter" && !e.shiftKey && !this.isComposing) {
        e.preventDefault();
        this.sendMessage();
      }
    },

    // ------ ÌååÏùº Ï≤òÎ¶¨ ------
    fileEmoji(name) {
      if (name.endsWith(".pdf")) return "üìï";
      if (name.endsWith(".docx")) return "üìò";
      if (name.endsWith(".xlsx") || name.endsWith(".xls")) return "üìó";
      return "üìÑ";
    },
    async handleFileUpload(e) {
      const incoming = Array.from(e.target.files || []);
      if (!incoming.length) return;

      const validExtensions = /\.(pdf|txt|docx|png|jpg|jpeg|xls|xlsx)$/i;
      const currentTotal = this.uploadedFiles.reduce((s,f)=>s+f.size,0);
      const seen = new Set(this.uploadedFiles.map(f => `${f.name}:${f.size}`));

      let added = [];
      let totalAddSize = 0;

      for (const f of incoming) {
        if (!validExtensions.test(f.name)) { this.showError(`‚ùå ÏßÄÏõê ÏïàÌï®: ${f.name}`); continue; }
        if (this.uploadedFiles.length + added.length >= this.LIMIT_MAX_FILES) { this.showError("‚ùå ÏµúÎåÄ 3Í∞ú ÌååÏùº"); break; }
        if (f.size > this.LIMIT_PER_FILE) { this.showError(`‚ùå 10MB Ï¥àÍ≥º: ${f.name}`); continue; }
        if (currentTotal + totalAddSize + f.size > this.LIMIT_TOTAL) { this.showError("‚ùå Ï¥ù 25MB Ï¥àÍ≥º"); break; }

        const key = `${f.name}:${f.size}`;
        if (seen.has(key)) continue;

        added.push(f);
        totalAddSize += f.size;
      }

      for (const f of added) {
        this.uploadedFiles.push(f);
        if (f.type.startsWith("image/")) {
          const url = URL.createObjectURL(f);
          this.previewURLs.push(url);
        } else {
          this.previewURLs.push("");
        }
      }

      this.$nextTick(this.scrollToBottom);
      e.target.value = "";
    },
    removeFile(index) {
      const url = this.previewURLs[index];
      if (url) URL.revokeObjectURL(url);
      this.previewURLs.splice(index,1);
      this.uploadedFiles.splice(index,1);
      this.$nextTick(this.scrollToBottom);
    },
    clearAllPreviews() {
      this.previewURLs.forEach(u => u && URL.revokeObjectURL(u));
      this.previewURLs = [];
      this.uploadedFiles = [];
      this.$nextTick(this.scrollToBottom);
    },

    async buildAttachmentPayloadForMessage() {
      const result = [];
      for (let i=0; i<this.uploadedFiles.length; i++) {
        const f = this.uploadedFiles[i];
        if (f.type.startsWith("image/")) {
          const dataUrl = await this.readFileAsDataURL(f);
          result.push({ kind: "image", src: dataUrl, name: f.name });
        } else {
          result.push({ kind: "file", emoji: this.fileEmoji(f.name), name: f.name });
        }
      }
      return result;
    },
    readFileAsDataURL(file) {
      return new Promise((resolve, reject) => {
        const fr = new FileReader();
        fr.onload = () => resolve(fr.result);
        fr.onerror = (err) => {
          console.warn("FileReader error:", err);
          reject(err);
        };
        fr.readAsDataURL(file);
      });
    },

    // ------ ÎìúÎûòÍ∑∏ ------
    onDragEnter(e) { e.preventDefault(); this.dragCounter++; this.isDraggingFile = true; },
    onDragLeave(e) { e.preventDefault(); this.dragCounter--; if (this.dragCounter===0) this.isDraggingFile=false; },
    onDragOver(e) { e.preventDefault(); this.isDragOver = true; },
    onDrop(e) {
      e.preventDefault();
      this.dragCounter = 0;
      this.isDraggingFile = false;
      this.isDragOver = false;
      const dt = Array.from(e.dataTransfer.files || []);
      const evt = { target: { files: dt } };
      this.handleFileUpload(evt);
    },

    // ------ ÏÑ§Ï†ï ÎìúÎ°úÏñ¥ ------
    onSettingsClick() {
      this.openSettings();
    },
    // ‚úÖ ÌÉúÍ∑∏ ÌÅ¥Î¶≠ Ïãú ÌÉÄÍπÉ Ï†ÑÎã¨
    onDivisionTagClick() {
      this.openSettings('division');
    },
    //onJobTagClick() {
    //  this.openSettings('job');
    //},
    // ‚úÖ target: 'division' | 'job' | undefined
    openSettings(target) {
      this.showSettingsModal = true;
      document.body.classList.add('lock-scroll'); // ‚úÖ Ïä§ÌÅ¨Î°§ Ïû†Í∏à
      document.body.style.overflow = 'hidden';
      // ESC Îã´Í∏∞ Ìï∏Îì§Îü¨
      this._escHandler = (e) => { if (e.key === 'Escape') this.closeSettings(); };
      document.addEventListener("keydown", this._escHandler);
  
      // ÎìúÎ°úÏñ¥ DOM Î†åÎçî ‚Üí Ìä∏ÎûúÏßÄÏÖò ÎÅùÎÇú Îí§ Ïä§ÌÅ¨Î°§
      this.$nextTick(() => {
        const doScroll = () => this.scrollToDrawerTarget(target);
        // Ï†ÑÌôò ÏãúÍ∞Ñ(.3s) + ÏïΩÍ∞ÑÏùò Ïó¨Ïú†
        setTimeout(doScroll, 320);
      });
    },
  
    closeSettings() {
      this.showSettingsModal = false;
      document.body.style.overflow = '';
      document.body.classList.remove('lock-scroll'); // ‚úÖ Ïä§ÌÅ¨Î°§ Ìï¥Ï†ú
      document.removeEventListener("keydown", this._escHandler);
    },
  
    // ‚úÖ Ïä§ÌÅ¨Î°§ & Ìè¨Ïª§Ïä§
    scrollToDrawerTarget(target) {
      const drawer = this.$refs.drawer;
      if (!drawer || !target) return;
  
      // ÌÉÄÍπÉ ÏóòÎ¶¨Î®ºÌä∏ ÏÑ†ÌÉù
      const el =
        target === 'division'
          ? this.$refs.divisionField
          : target === 'job'
          ? this.$refs.jobField
          : null;
  
      if (!el) return;
  
      // Ïä§ÌÅ¨Î°§ Ïù¥Îèô
      try {
        el.scrollIntoView({ behavior: 'smooth', block: 'center' });
      } catch (_) {
        // ÏùºÎ∂Ä Î∏åÎùºÏö∞Ï†Ä Ìè¥Î∞±
        const top = el.getBoundingClientRect().top + drawer.scrollTop - drawer.clientHeight / 2;
        drawer.scrollTo({ top, behavior: 'smooth' });
      }
  
      // Ìè¨Ïª§Ïä§
      this.$nextTick(() => {
        if (target === 'job') {
          // ÏûÖÎ†•Ï∞Ω Ìè¨Ïª§Ïä§
          el.focus?.();
        } else if (target === 'division') {
          // ÏÑ†ÌÉùÎêú ÎùºÎîîÏò§ ÎòêÎäî Ï≤´ ÎùºÎîîÏò§Ïóê Ìè¨Ïª§Ïä§
          const radio =
            el.querySelector('input[type=radio]:checked') ||
            el.querySelector('input[type=radio]');
          radio?.focus?.();
        }
      });
    },

    loadSettings() {
      try {
        const raw = localStorage.getItem("chat_profile");
        if (raw) {
          const p = JSON.parse(raw);
          this.profile = {
            name: p.name || "",
            email: p.email || "",
            phone: p.phone || "",
            division: p.division || "",
            job: p.job || "",
            avatar: p.avatar || ""   // ‚Üê Ï∂îÍ∞Ä
          };
        } else {
          this.profile.division = "ÏòÅÏóÖ";
          this.profile.job = "Î≥¥ÌóòÏÑ§Í≥ÑÏÇ¨";
        }
      } catch (err) {
        console.warn("Failed to load profile from localStorage:", err);
        this.profile = { name:"", email:"", phone:"", division:"ÏòÅÏóÖ", job:"Î≥¥ÌóòÏÑ§Í≥ÑÏÇ¨", avatar:"" };
      }
    },
    saveSettings() {
      this.saveSettingsToStorage();
      this.closeSettings();
      //this.showError("‚úÖ ÌîÑÎ°úÌïÑÏù¥ Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§.");
    },
    saveSettingsToStorage() {
      try {
        localStorage.setItem("chat_profile", JSON.stringify(this.profile));
      } catch (err) {
        console.warn("Failed to save profile to localStorage:", err);
      }
    },
    triggerAvatarPick() {
      this.$refs.avatarInput?.click();
    },
    async onAvatarSelected(e) {
      const file = e?.target?.files?.[0];
      if (!file) return;
      if (!file.type.startsWith("image/")) {
        this.showError("Ïù¥ÎØ∏ÏßÄ ÌååÏùºÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.");
        return;
      }
      // Í∞ÑÎã®Ìûà base64Î°ú Ï†ÄÏû• (ÏõêÌïúÎã§Î©¥ Î¶¨ÏÇ¨Ïù¥Ï¶à/ÏïïÏ∂ï Î°úÏßÅ Ï∂îÍ∞Ä Í∞ÄÎä•)
      const reader = new FileReader();
      reader.onload = () => {
        this.profile.avatar = reader.result;
        this.saveSettingsToStorage();  // Ï¶âÏãú Ï†ÄÏû•
      };
      reader.onerror = (err) => console.warn("avatar read error:", err);
      reader.readAsDataURL(file);
    },

    // ‚úÖ Ï†ÑÌôîÎ≤àÌò∏ ÌïòÏù¥Ìîà Ìè¨Îß∑ÌÑ∞
    formatPhone(v) {
      const d = (v || "").replace(/\D/g, "").slice(0, 11);
      if (d.startsWith("02")) {
        if (d.length <= 2) return d;
        if (d.length <= 5) return `${d.slice(0,2)}-${d.slice(2)}`;
        return `${d.slice(0,2)}-${d.slice(2, d.length-4)}-${d.slice(-4)}`;
      } else {
        if (d.length <= 3) return d;
        if (d.length <= 7) return `${d.slice(0,3)}-${d.slice(3)}`;
        return `${d.slice(0,3)}-${d.slice(3, d.length-4)}-${d.slice(-4)}`;
      }
    },
    onPhoneInput(e) {
      const formatted = this.formatPhone(e.target.value);
      this.profile.phone = formatted;
      this.$nextTick(() => {
        try {
          const el = e.target;
          const pos = formatted.length;
          el.setSelectionRange(pos, pos);
        } catch (err) {
          console.debug("setSelectionRange unsupported:", err);
        }
      });
    },
    
    applySuggestion(text, {send=false} = {}) {
      this.userInput = text;
      this.forceInitPrompts = false;     
      this.$nextTick(() => {
        this.autoResize(); // ÏûÖÎ†•Ïπ∏ ÎÜíÏù¥ ÎßûÏ∂§
        if (send) this.sendMessage();
        else this.$refs.chatInput?.focus();
      });
    },
  
    // ÏùëÎãµ ÌõÑ ÌõÑÏÜç Ï∂îÏ≤ú ÏÉùÏÑ±(Í∞ÑÎã® Í∑úÏπô + ÏÑúÎ≤Ñ Ïã†Ìò∏ ÌååÏã±)
    async updateFollowupSuggestions({ lastUser, botText }) {
      try {
        const fd = new FormData();
        fd.append("session_id", this.sessionId || this.generateSessionId());
        fd.append(
          "question",
          [
            "ÏµúÍ∑º ÎåÄÌôî Îß•ÎùΩÏùÑ Î∞îÌÉïÏúºÎ°ú Í≥†Í∞ùÏù¥ Î∞îÎ°ú Ïù¥Ïñ¥ÏÑú Ìï† Í∞ÄÎä•ÏÑ±Ïù¥ ÌÅ∞ Ïã§Î¨¥Ï†Å ÌõÑÏÜç ÏßàÎ¨∏ 3~6Í∞ú ÏÉùÏÑ±.",
            'Ï∂úÎ†•ÏùÄ JSON Î∞∞Ïó¥Îßå. Ïòà) ["ÏßàÎ¨∏1","ÏßàÎ¨∏2",...]',
            "ÏΩîÎìúÎ∏îÎ°ù(```), ÎßàÌÅ¨Îã§Ïö¥, Ï£ºÏÑù, ÏÑ§Î™ÖÎ¨∏, Ï†ëÎëêÏñ¥ Í∏àÏßÄ."
          ].join(" ")
        );
    
        const categoryMeta = this.buildCategoryMetaString();
        const parts = categoryMeta.split("-");
        const jobValue = parts.slice(1).join("-");
        
        
        fd.append("category", "Ï∂îÍ∞ÄÏßàÎ¨∏");
        fd.append("job", jobValue);
    
        const res = await fetch(`${this.API_BASE}/chat/suggestions`, {
          method: "POST",
          body: fd
        });
        if (!res.ok) throw new Error(`ÏÑúÎ≤Ñ Ïò§Î•ò: ${res.status}`);
    
        // --- JSON Î∞∞Ïó¥ Î∞îÎ°ú Î∞õÍ∏∞ ---
        const arr = await res.json();
        if (!Array.isArray(arr)) throw new Error("ÏùëÎãµÏù¥ Î∞∞Ïó¥ ÌòïÏãùÏù¥ ÏïÑÎãò");
    
        this._applyFollowups(arr);
        this.isAwaitingFollowups = false;
      } catch (err) {
        console.debug("Ï∂îÍ∞ÄÏßàÎ¨∏ API Ïã§Ìå®, Ìè¥Î∞± ÏÇ¨Ïö©:" + botText, err);
        const base = (lastUser || "").replace(/\s+/g, " ").trim();
        const topic = base.length > 0 ? base.slice(0, 32) : "Ïù¥ ÎÇ¥Ïö©";
        this.suggestedPrompts = [
          `${topic} Ïã§Ï†ú ÏÇ¨Î°Ä 3Í∞úÎßå ÏïåÎ†§Ï§ò`,
          `${topic} Ï†úÏïàÏÑú ÌòïÏãùÏúºÎ°ú ÏûëÏÑ±Ìï¥Ï§ò`,
          "ÎπÑÏä∑Ìïú ÏÉÅÌô©ÏóêÏÑú Ï£ºÏùòÌï¥Ïïº Ìï† Ï†êÏùÄ Î¨¥ÏóáÏù∏Í∞ÄÏöî?",
          "Ïù¥Í±∏ Ï†ÅÏö©ÌïòÎ©¥ Í∏∞ÎåÄÌï† Ïàò ÏûàÎäî Ìö®Í≥ºÎäî Î¨¥ÏóáÏù∏Í∞ÄÏöî?",
          "Ï∂îÍ∞ÄÎ°ú Ï∞∏Í≥†Ìï† ÎßåÌïú ÏûêÎ£åÍ∞Ä ÏûàÎÇòÏöî?",
          "Îã§Î•∏ ÏòµÏÖòÏù¥ÎÇò ÎåÄÏïàÏù¥ ÏûàÎã§Î©¥ ÏïåÎ†§Ï£ºÏÑ∏Ïöî"
        ];
        this.isAwaitingFollowups = false;
      }
    },
    
    // ‚úÖ category Î¨∏ÏûêÏó¥ ÏÉùÏÑ±Í∏∞ (Ï†ÑÌôîÎäî Ïà´ÏûêÎßå)
    buildCategoryMetaString() {
      const phoneDigits = (this.profile.phone || "").replace(/\D+/g, "");
      const parts = [
        (this.profile.division || "").trim(),
        (this.profile.job || "").trim(),
        `Ïù¥Î¶Ñ:${(this.profile.name || "").trim()}`,
        `Ïù¥Î©îÏùº:${(this.profile.email || "").trim()}`,
        `Ï†ÑÌôî:${phoneDigits}`
      ].filter(Boolean);
      return parts.join("-");
    },

    // ------ Ï†ÑÏÜ° ------
    async sendMessage() {
      if (!this.canSend || this.isSending) return;
      this.forceInitPrompts = false;   // üîπ Ï†ÑÏÜ° Ïãú Ï¥àÍ∏∞ Î™®Îìú Ï¢ÖÎ£å
      this.isSending = true;
      
      this.isAwaitingFollowups = true;

      if (this.abortController) this.abortController.abort();
      this.abortController = new AbortController();

      if (!this.sessionId) this.sessionId = this.generateSessionId();

      const text = this.userInput.trim();
      const hasText = text.length > 0;
      const hasFiles = this.uploadedFiles.length > 0;
      const hasPDF = this.uploadedFiles.some(f => /\.pdf$/i.test(f.name));

      // ÏÇ¨Ïö©Ïûê Î≤ÑÎ∏î(Ï≤®Î∂Ä+ÌÖçÏä§Ìä∏) Î®ºÏ†Ä Ï∂úÎ†•
      const attachmentsForBubble = await this.buildAttachmentPayloadForMessage();
      const userMsg = { role: "user", text: hasText ? text : (hasFiles ? "(Ï≤®Î∂Ä Ï†ÑÏÜ°)" : ""), attachments: attachmentsForBubble };
      this.messages.push(userMsg);

      // ÏûÖÎ†• ÏòÅÏó≠ Ï¥àÍ∏∞Ìôî & Ïä§ÌÅ¨Î°§
      this.userInput = "";
      this.$nextTick(() => {
        const el = this.$refs.chatInput;
        if (el) el.style.height = "auto";
      });

      // Ï†ÑÏÜ° Ï§ÄÎπÑ: FormData
      const fd = new FormData();
      fd.append("session_id", this.sessionId);
      fd.append("question", hasText ? text : "[FILE_UPLOAD_ONLY]");

      const categoryMeta = this.buildCategoryMetaString(); // Ïòà: "ÏòÅÏóÖ-Î≥¥ÌóòÏÑ§Í≥ÑÏÇ¨-Ïù¥Î¶Ñ:ÌôçÍ∏∏Îèô-Ïù¥Î©îÏùº:..."
      const parts = categoryMeta.split("-");
      
      // Îß® Ïïû Í∞í = category
      let categoryValue = parts[0] || "";
      
      // ÎÇòÎ®∏ÏßÄ Í∞í = job ÌïÑÎìúÏóê Î∂ôÏó¨ÏÑú Ï†ÑÎã¨
      const jobValue = parts.slice(1).join("-");
      
      // ‚úÖ Ïπ© ÌÅ¥Î¶≠Ïù¥ "Î≥¥Ïû•Î∂ÑÏÑù"Ïù∏ Í≤ΩÏö∞ category ÏïûÏóê Î≥¥Ïû•Î∂ÑÏÑù Î∂ôÏù¥Í∏∞
      if (this.lastClickedChipTitle === 'Î≥¥Ïû•Î∂ÑÏÑù') {
        if (categoryValue) {
          categoryValue = `Î≥¥Ïû•Î∂ÑÏÑù-${categoryValue}`;
        } else {
          categoryValue = 'Î≥¥Ïû•Î∂ÑÏÑù';
        }
      }
      
      fd.append("category", categoryValue);
      fd.append("job", jobValue);

      // ÌååÏùº Ï≤®Î∂Ä
      this.uploadedFiles.forEach(f => fd.append("files", f));

      // ÎØ∏Î¶¨Î≥¥Í∏∞ Ï†ïÎ¶¨
      this.clearAllPreviews();
      
      const startTime = Date.now(); // ‚è≥ ÏãúÏûë ÏãúÍ∞Å Í∏∞Î°ù
      
      // Î¥á ÏûêÎ¶¨(Ïä§Ìä∏Î¶¨Î∞ç ÏóÖÎç∞Ïù¥Ìä∏)
      const botIndex = this.messages.length;
      //this.messages.push({ role: "bot", text: "", loading: true });
      this.messages.push({
              role: "bot",
              text: "",
              loading: true,
              // PDFÍ∞Ä ÏûàÏúºÎ©¥ ÏïàÎÇ¥ Î¨∏Íµ¨ ÌëúÏãú
              loadingText: hasPDF ? "üìÑ PDFÎ•º ÌÖçÏä§Ìä∏Î°ú Î≥ÄÌôò Ï§ë" : ""
            });
      this.scrollToBottom();
      
       // ‚è≥ Ï¥à Ïπ¥Ïö¥Ìä∏ ÏóÖÎç∞Ïù¥Ìä∏ ÌÉÄÏù¥Î®∏
      const timer = setInterval(() => {
        const seconds = Math.floor((Date.now() - startTime) / 1000);
        const msg = this.messages[botIndex];
        if (msg && msg.loading) {
          msg.loadingText =
            (hasPDF ? "üìÑ PDFÎ•º ÌÖçÏä§Ìä∏Î°ú Î≥ÄÌôò Ï§ë" : "ÏùëÎãµ ÏÉùÏÑ± Ï§ë") +
            ` ${seconds}s `; // Ï¥à ÌëúÏãú
          this.$forceUpdate(); // Vue Í∞ïÏ†ú Î†åÎçîÎßÅ
        } else {
          clearInterval(timer); // Î°úÎî©Ïù¥ ÎÅùÎÇòÎ©¥ ÌÉÄÏù¥Î®∏ Ï†ïÏßÄ
        }
      }, 1000);

      try {
        const res = await fetch(`${this.API_BASE}/chat/stream-file`, {
          method: "POST",
          body: fd,
          signal: this.abortController.signal
        });

        if (!res.ok || !res.body) throw new Error(`ÏÑúÎ≤Ñ Ïò§Î•ò: ${res.status}`);

        const reader = res.body.getReader();
        const decoder = new TextDecoder("utf-8");
        let done = false;
        let botText = "";

        while (!done) {
          const { value, done: isDone } = await reader.read();
          done = isDone;
          if (value) {
            const chunk = decoder.decode(value, { stream: true });
            botText += chunk;
            this.messages.splice(botIndex, 1, { role: "bot", text: botText, loading: false });
            
            this.scrollToBottom();
          }
        }
      } catch (err) {
        const aborted = err?.name === "AbortError";
        this.messages.splice(botIndex, 1, {
          role: "bot",
          text: aborted ? "‚èπÔ∏è Ïù¥Ï†Ñ ÏöîÏ≤≠ÏùÑ Ï∑®ÏÜåÌñàÏäµÎãàÎã§." : "‚ùå ÏÑúÎ≤ÑÏôÄ Ïó∞Í≤∞Ìï† Ïàò ÏóÜÏäµÎãàÎã§.",
          loading: false
        });
        this.isAwaitingFollowups = false;
      } finally {
        clearInterval(timer); // ÏïàÏ†ÑÌïòÍ≤å ÌÉÄÏù¥Î®∏ Ï†ïÏßÄ
        this.isSending = false;
        const lastBot = this.messages[this.messages.length - 1]?.text || "";
        this.updateFollowupSuggestions({ lastUser: hasText ? text : "", botText: lastBot });
        this.$nextTick(() => {
          const container = this.$refs.messagesContainer;
          if (container) {
            container.querySelectorAll('.chat-bubble.bot .md-block, .chat-bubble.bot .html-block')
              .forEach(el => this.colorizeStatus(el));
          }
        });
        this.lastClickedChipTitle = null;
      }
    }
  }
};
</script>

<style>
/* ===== Design Tokens (Vulk ÌÜ§) ===== */
:root{
  --aa-bg: #ffffff;
  --aa-text: #111827;
  --aa-muted: #6B7280;
  --aa-border: #E5E7EB;
  --aa-primary: #6366F1; /* indigo-500 */
  --aa-primary-2: #7C3AED; /* violet-600 */
  --aa-success: #10B981;
  --aa-error: #DC2626;
  --aa-radius: 12px;
  --aa-pill-radius: 999px;
  --aa-shadow: 0 10px 30px rgba(0,0,0,.12);
  --siri-blue-1:#60A5FA; /* blue-400 */
  --siri-blue-2:#3B82F6; /* blue-500 */
  --siri-blue-3:#2563EB; /* blue-600 */
  /* Base UI Primary (Ï∞∏Í≥†) */
  --ui-primary: #3B82F6;

  /* ÌåîÎ†àÌä∏ ‚ë† */
  --tag-div-start:#6366F1; --tag-div-end:#8B5CF6; /* Íµ¨Î∂Ñ */
  --tag-job-start:#06B6D4; --tag-job-end:#10B981; /* ÏßÅÏóÖ */

  /* Í≥µÌÜµ */
  --tag-text-on: #FFFFFF;
  --tag-border-div: rgba(99,102,241,.28);
  --tag-border-job: rgba(16,185,129,.28);
  --tag-gloss: .20; /* 0.18~0.28 ÏÇ¨Ïù¥ Ï°∞Ï†à */
}

/* ‚úÖ Ï†ÑÏ≤¥ Ï±ÑÌåÖ ÎûòÌçº */
.chat-wrapper {
  width: 100%;
  max-width: 600px;
  height: 100vh;
  margin: 0 auto;
  display: flex;
  flex-direction: column;
  background-color: var(--aa-bg);
  border: 1px solid transparent;
  border-radius: 10px;
  overflow: hidden;
  position: relative;
}

/* ‚úÖ ÏÉÅÎã® Î°úÍ≥† Ìó§Îçî */
.chat-header {
  position: fixed;
  top: 0; left: 0; right: 0;
  margin: 0 auto;
  width: 100%;
  max-width: 600px;
  padding: 12px 16px;
  border-bottom: 1px solid var(--aa-border);
  background-color: var(--aa-bg);
  z-index: 1001;
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 8px;
  box-sizing: border-box;
  overflow: hidden;  /* ‚Üê Ïö∞Ï∏° ÌäÄÏñ¥ÎÇòÏò¥ Î∞©ÏßÄ */
}
.chat-logo { height: 32px; width: auto; }
.header-tags { display: flex; align-items: center; gap: 6px; margin-left: 8px; flex: 1; position: relative;}
.tag { font-size: 12px; padding: 4px 8px; background: #eef2ff; color: #3730A3; border-radius: var(--aa-pill-radius); }
.settings-btn { background: transparent; border: none; font-size: 18px; cursor: pointer; }

/* ‚úÖ Î©îÏãúÏßÄ ÏòÅÏó≠ */
.chat-messages {
  position: relative;
  flex: 1 1 auto;
  overflow-y: auto;
  background-color: var(--aa-bg);
  -webkit-overflow-scrolling: touch;
  overscroll-behavior: contain;
  margin-top: 56px;   /* Ìó§Îçî */
  margin-bottom: 180px; /* ÏûÖÎ†•Ï∞Ω + compose-preview Ïó¨Ïú† */
  padding: 12px;
}

/* ‚úÖ Ï±ÑÌåÖ ÎßêÌíçÏÑ† */
.chat-bubble { display: flex; margin-bottom: 12px; max-width: 85%; }
.chat-bubble.user { justify-content: flex-end; align-self: flex-end; width: fit-content; max-width: 90%; margin-left: auto; }
.chat-bubble.bot { justify-content: flex-start; align-self: flex-start; max-width: 90% !important; }

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
   1) Î¥á Î≤ÑÎ∏î/ÎÇ¥Ïö©/ÎßàÌÅ¨Îã§Ïö¥ Î∏îÎ°ù: Í∞ÄÎ°ú Ïä§ÌÅ¨Î°§ Ï†ÑÎ©¥ Ï∞®Îã®
   ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
.chat-bubble.bot,
.chat-bubble.bot .bubble-content,
.chat-bubble.bot .md-block,
.chat-bubble.bot .html-block {
  overflow-x: hidden !important;      /* ‚Üê Ï†ÑÏ≤¥ Î≤ÑÎ∏îÏóê Í∞ÄÎ°ú Ïä§ÌÅ¨Î°§ Í∏àÏßÄ */
  max-width: 100%;
  word-break: break-word;
  overflow-wrap: anywhere;             /* Í∏¥ ÌÜ†ÌÅ∞(URL Îì±) Í∞ïÏ†ú Ï§ÑÎ∞îÍøà */
}

/* ÏΩîÎìúÎ∏îÎ°ù/Ïù∏ÎùºÏù∏ÏΩîÎìúÎèÑ Í∞ÄÎ°ú Ïä§ÌÅ¨Î°§ Ïïà ÏÉùÍ∏∞Í≤å Ï§ÑÎ∞îÍøà */
.chat-bubble.bot pre,
.chat-bubble.bot code {
  white-space: pre-wrap;
  overflow-x: hidden;
  max-width: 100%;
}

/* Ïù¥ÎØ∏ÏßÄÍ∞Ä Î≤ÑÎ∏îÏùÑ ÎÑòÏßÄ ÏïäÍ≤å */
.chat-bubble.bot .bubble-content img {
  max-width: 100%;
  height: auto;
}

/* ‚ë† Î¥á Î≤ÑÎ∏î Ï†ÑÎ∞ò: Í∞ÄÎ°ú Ïä§ÌÅ¨Î°§ Í∏àÏßÄ */
.chat-bubble.bot,
.chat-bubble.bot .bubble-content,
.chat-bubble.bot .md-block,
.chat-bubble.bot .html-block {
  overflow-x: hidden !important;
  max-width: 100%;
  word-break: break-word;
  overflow-wrap: anywhere;
}

/* ‚ë° ÌëúÎßå Ïä§ÌÅ¨Î°§: ÎûòÌçº Ïª®ÌÖåÏù¥ÎÑà */
.chat-bubble.bot .table-scroll {
  overflow-x: auto;              /* ‚Üê Í∞ÄÎ°ú Ïä§ÌÅ¨Î°§ ÌóàÏö© */
  overflow-y: hidden;
  -webkit-overflow-scrolling: touch;
  margin: 12px 0;
  padding: 8px;                  /* Ïπ¥Îìú ÎÇ¥Î∂Ä Ïó¨Î∞± */
  background: #fff;              /* Ìù∞ Î∞∞Í≤Ω */
  border-radius: 8px;            /* ÎùºÏö¥Îìú */
  box-shadow: 0 2px 8px rgba(0,0,0,0.05);
  scrollbar-gutter: stable both-edges; /* Ïä§ÌÅ¨Î°§Î∞î Ï†êÌîÑ Î∞©ÏßÄ(ÎåÄÏùë Î∏åÎùºÏö∞Ï†Ä) */
}

/* ‚ë¢ Ìëú ÏûêÏ≤¥Îäî ÎÇ¥Ïö© ÎÑàÎπÑÎßåÌÅº ÎäòÏñ¥ÎÇòÎèÑÎ°ù */
.chat-bubble.bot .table-scroll table {
  width: max-content;            /* ÎÇ¥Ïö©ÎßåÌÅº Í∞ÄÎ°ú ÌôïÏû• */
  border-collapse: collapse;
}

/* ‚ë£ Ìëú ÏÖÄ Í∞ÄÎèÖÏÑ± */
.chat-bubble.bot .table-scroll th,
.chat-bubble.bot .table-scroll td {
  border: 1px solid #ddd;
  padding: 8px 10px;
  white-space: nowrap;           /* Ï§ÑÎ∞îÍøà Í∏àÏßÄ ‚Üí Í∞ÄÎ°ú Ïä§ÌÅ¨Î°§ Ïú†ÎèÑ */
  text-align: center;
}
.chat-bubble.bot .table-scroll th {
  background: #f9fafb;
  font-weight: 700;
}

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
   2) Ìëú(table)ÏóêÏÑúÎßå Í∞ÄÎ°ú Ïä§ÌÅ¨Î°§ ÌóàÏö©
   ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
.chat-bubble.bot .md-block table,
.chat-bubble.bot .html-block table {
  display: block;                      /* Ìëú ÏûêÏ≤¥ Ïä§ÌÅ¨Î°§ Ïª®ÌÖåÏù¥ÎÑà */
  width: max-content;
  max-width: none;
  overflow-x: auto !important;
  overflow-y: hidden;
  -webkit-overflow-scrolling: touch;
  
  margin: 12px 0;
  border-collapse: collapse;

  /* Í∞ÄÎèÖÏÑ± Ï∂îÍ∞Ä Ïä§ÌÉÄÏùº */
  background: #fff;                     /* Ìù∞ÏÉâ Î∞∞Í≤Ω */
  border-radius: 8px;                   /* ÎùºÏö¥Îìú Î™®ÏÑúÎ¶¨ */
  padding: 8px;                         /* ÌÖåÎëêÎ¶¨ ÏïàÏ™Ω Ïó¨Î∞± */
  box-shadow: 0 2px 8px rgba(0,0,0,0.05);/* ÏùÄÏùÄÌïú Í∑∏Î¶ºÏûê */
}

/* Ìëú ÏÖÄ */
.chat-bubble.bot .md-block th,
.chat-bubble.bot .md-block td,
.chat-bubble.bot .html-block th,
.chat-bubble.bot .html-block td {
  border: 1px solid #ddd;
  padding: 8px 10px;
  text-align: center;
  white-space: nowrap;
}

/* Ìó§Îçî ÏÖÄ Ïä§ÌÉÄÏùº */
.chat-bubble.bot .md-block th,
.chat-bubble.bot .html-block th {
  background: #f9fafb;
  font-weight: 700;
}

/* (ÏÑ†ÌÉù) Î™®Î∞îÏùºÏóêÏÑú Ïä§ÌÅ¨Î°§Î∞î ÌÑ∞Ïπò Ïó¨Ïú† */
@media (max-width: 480px) {
  .chat-bubble.bot .md-block table,
  .chat-bubble.bot .html-block table {
    padding-bottom: 2px;
  }
}
/* ‚úÖ ÏïÑÎ∞îÌÉÄ */
.avatar { width: 32px; height: 32px; font-size: 20px; margin-right: 8px; align-self: flex-start; }
.chat-bubble.user .avatar { display: none; }

/* ‚úÖ ÎßêÌíçÏÑ† Ïä§ÌÉÄÏùº */
.bubble-content {
  padding: 1px 14px; border-radius: 12px; white-space: normal;
  line-height: 1.6; word-break: break-word; text-align: left; font-size: 15px;
}
.chat-bubble.user .bubble-content { background-color: #d1e9ff; color: #000; border-bottom-right-radius: 0; line-height: 1.6; }
.chat-bubble.bot .bubble-content { background-color: #eeeeee; color: #000; border-bottom-left-radius: 0; line-height: 1.6;}
.chat-bubble.user .bubble-content {
  padding: 1px 10px !important;  /* ÏúÑ¬∑ÏïÑÎûò 1px, Ï¢åÏö∞ 10px */
  line-height: 1.25 !important;  /* ÌñâÍ∞Ñ Ï¥òÏ¥òÌïòÍ≤å */
}

/* ‚úÖ Î≤ÑÎ∏î ÎÇ¥Î∂Ä Ï≤®Î∂Ä */
.bubble-attachments { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 6px; }
.bubble-attachment {
  display: inline-flex; align-items: center; gap: 6px; border: 1px solid var(--aa-border);
  border-radius: 8px; padding: 6px; background: #fff;
}
.bubble-attachment img { width: 64px; height: 64px; object-fit: cover; border-radius: 6px; display: block; }
.file-emoji { font-size: 16px; }
.file-label { max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

/* ‚úÖ ÌîåÎü¨Ïä§ Î≤ÑÌäº Ïä§ÌÉÄÏùº */
.upload-button {
  width: 36px; height: 36px; background-color: #fff; border: 1px solid #ccc;
  border-radius: 50%; display: flex; align-items: center; justify-content: center;
  cursor: pointer; padding: 0; margin: 0; transition: background-color 0.2s ease;
}
.upload-button:hover { background-color: #f5f5f5; }

/* ‚ú® ÏûëÏÑ± Ï§ë Ï≤®Î∂Ä ÎØ∏Î¶¨Î≥¥Í∏∞ (ÏûÖÎ†•Ï∞Ω ÏúÑ) */
.compose-preview-container {
  position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%);
  width: calc(100% - 32px); max-width: 600px; background: #fff;
  border: 1px solid var(--aa-border); border-radius: 10px; padding: 8px;
  display: flex; flex-wrap: wrap; gap: 8px; z-index: 1001;
  box-shadow: 0 4px 12px rgba(0,0,0,0.08); box-sizing: border-box;
}
.compose-preview-item {
  position: relative; border: 1px solid #ccc; border-radius: 8px; padding: 4px 8px;
  background-color: #f9f9f9; display: flex; align-items: center; gap: 6px;
}
.image-preview img { width: 48px; height: 48px; object-fit: cover; border-radius: 4px; }
.file-icon { font-size: 14px; }
.file-name { max-width: 120px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.remove-file {
  background: none; border: none; color: red; font-size: 14px;
  position: absolute; top: 2px; right: 4px; cursor: pointer;
}

/* ‚úÖ ÏûÖÎ†•Ï∞Ω Ïª®ÌÖåÏù¥ÎÑà */
.chat-input-container{
  position: fixed; bottom: 16px; left: 50%; transform: translateX(-50%);
  width: calc(100% - 32px); max-width: 600px;
  z-index: 1300; gap: 8px; display: flex; align-items: flex-end;
  padding: 8px 48px 8px 16px; box-sizing: border-box;

  background: transparent;  /* Í∏ÄÎ°úÏö∞/ÎÇ¥Î∂ÄÎäî pseudoÎ°ú */
  border: none;
  border-radius: 12px;
  box-shadow: none;
}
@supports (padding: max(0px)){
  .chat-input-container{ padding-bottom: max(8px, env(safe-area-inset-bottom)); }
}


/* Î∞îÍπ• Ïó∞Ìïú Î∏îÎ£® Í∏ÄÎ°úÏö∞ */
.chat-input-container::before{
  content:"";
  position:absolute; inset:-6px;
  border-radius: inherit;
  background: linear-gradient(135deg, var(--siri-blue-1), var(--siri-blue-2), var(--siri-blue-3));
  filter: blur(14px);
  opacity:.35;                 /* ‚Üê Ïó∞ÌïòÍ≤å */
  z-index:-2;
  transition: filter .25s ease, opacity .25s ease;
}

/* ÎÇ¥Î∂ÄÎäî ÏôÑÏ†Ñ Ìù∞ÏÉâ Ï∫°Ïäê */
.chat-input-container::after{
  content:"";
  position:absolute; inset:0;
  border-radius: inherit;
  background:#ffffff;          /* ‚Üê Ìù∞ÏÉâ */
  border: 1px solid rgba(59,130,246,.15);  /* ÏïÑÏ£º Ïó∞Ìïú Î∏îÎ£® ÌÖåÎëêÎ¶¨ */
  box-shadow:
    inset 0 1px 0 rgba(255,255,255,.9),
    0 6px 16px rgba(0,0,0,.06),
    0 8px 24px rgba(59,130,246,.08);
  backdrop-filter: saturate(130%) blur(4px);
  -webkit-backdrop-filter: saturate(130%) blur(4px);
  z-index:-1;
}

/* Ìè¨Ïª§Ïä§ Ïãú ÏÇ¥ÏßùÎßå Í∞ïÏ°∞ */
.chat-input-container:focus-within::before{ opacity:.55; filter: blur(16px); }
.chat-input-container:focus-within::after{
  border-color: rgba(59,130,246,.22);
  box-shadow:
    inset 0 1px 0 rgba(255,255,255,.95),
    0 8px 22px rgba(0,0,0,.08),
    0 0 0 2px rgba(59,130,246,.10);
}

/* ÎìúÎûòÍ∑∏ Ïò§Î≤ÑÎèÑ Ïó∞Ìïú ÌÜ§ Ïú†ÏßÄ */
.chat-input-container.dragover{ background: transparent; border:none; }
.chat-input-container.dragover::before{ opacity:.6; filter: blur(18px); }

/* ÏûÖÎ†•Ï∞ΩÏùÄ Ìà¨Î™Ö ‚Üí ÎÇ¥Î∂Ä Ìù∞ÏÉâÏù¥ Î≥¥ÏûÑ */
.chat-textarea{
  flex:1; border:none; background:transparent; outline:none;
  font-size:15px; padding:8px 0; line-height:1.5; min-height:24px; max-height:200px;
  letter-spacing: 0;      /* ÌòπÏãú Ïª§Ïä§ÌÖÄÎêú Í≤ΩÏö∞ Ï¥àÍ∏∞Ìôî */
  word-spacing: normal;   /* ÌòπÏãú Ïª§Ïä§ÌÖÄÎêú Í≤ΩÏö∞ Ï¥àÍ∏∞Ìôî */
  color:#0f172a;resize: none !important;
  -webkit-appearance: none;
  appearance: none;
}

.chat-input-container input,
.chat-input-container textarea {
  letter-spacing: 0px;   /* Í∏ÄÏûê Í∞ÑÍ≤©ÏùÑ Í∏∞Î≥∏Î≥¥Îã§ 0.5px Ï¢ÅÌûò */
  word-spacing: -2px;       /* Îã®Ïñ¥ Í∞ÑÍ≤©ÏùÑ Í∏∞Î≥∏Î≥¥Îã§ 1px Ï¢ÅÌûò */
}

/* WebKit(Chrome/Edge/Safari)ÏóêÏÑú Î™®ÏÑúÎ¶¨ Î¶¨ÏÇ¨Ïù¥Ï†Ä Ïà®ÍπÄ */
.chat-textarea::-webkit-resizer {
  display: none;
}
.chat-textarea::placeholder{ color:#94a3b8; opacity:.95; }

/*
.chat-input-container.dragover { border: 2px dashed #3b82f6; background-color: #f0f8ff; }

 ‚úÖ ÌÖçÏä§Ìä∏ÏóêÏñ¥Î¶¨Ïñ¥ 
.chat-textarea {
  flex: 1; border: none; resize: none; font-size: 15px; padding: 8px 0;
  line-height: 1.5; background: transparent; min-height: 24px; max-height: 200px;
  overflow-y: auto; outline: none; font-family: inherit;
}*/

/* ‚úÖ Ï†ÑÏÜ° Î≤ÑÌäº */
.send-button {
  position: absolute; right: 12px; bottom: 8px; width: 36px; height: 36px; border-radius: 50%;
  background-color: #3b82f6; border: none; display: flex; align-items: center; justify-content: center;
  cursor: pointer; transition: background-color 0.2s ease;
  box-shadow: 0 6px 16px rgba(59,130,246,.20);
}
.send-button:hover { background-color: #2563eb; }
.send-button:disabled { opacity: .6; cursor: not-allowed; }

/* ‚úÖ ÌÉÄÏù¥Ìïë Ïù∏ÎîîÏºÄÏù¥ÌÑ∞ */
.typing-indicator { display: inline-flex; align-items: center; gap: 4px; height: 20px; }
.dot { width: 6px; height: 6px; background-color: #888; border-radius: 50%; animation: blink 1.4s infinite ease-in-out both; }
.dot:nth-child(2){ animation-delay:.2s } .dot:nth-child(3){ animation-delay:.4s }

/* ‚úÖ ÎìúÎûòÍ∑∏ Ïò§Î≤ÑÎ†àÏù¥ */
.drag-overlay {
  position: fixed; inset: 0; background-color: rgba(240, 248, 255, 0.6);
  backdrop-filter: blur(2px); z-index: 3000; display: flex; align-items: center; justify-content: center;
  animation: pulse-bg 1.5s infinite ease-in-out; pointer-events: none;
}
.drag-overlay-content {
  font-size: 20px; font-weight: 600; padding: 24px 36px; border: 2px dashed #3b82f6;
  background-color: #ffffffcc; border-radius: 16px; color: #3b82f6; pointer-events: none;
  box-shadow: 0 6px 24px rgba(0,0,0,0.08);
}

/* ‚úÖ ÏóêÎü¨ ÌÜ†Ïä§Ìä∏ */
.error-toast {
  position: fixed; top: 70px; left: 50%; transform: translateX(-50%);
  background-color: #fee2e2; color: #b91c1c; padding: 10px 16px; border-radius: 8px;
  border: 1px solid #fca5a5; box-shadow: 0 2px 8px rgba(0,0,0,0.1); z-index: 2000; font-size: 14px;
  animation: fadeInOut 4s ease-in-out;
}

/* ===== ÎìúÎ°úÏñ¥ & Ï†ÑÌôò ===== */

/* Î∞±ÎìúÎ°≠: Ïö∞Ï∏° Ï†ïÎ†¨ */
.aa-modal-backdrop {
  position: fixed;
  inset: 0;
  display: flex;
  justify-content: flex-end;
  align-items: stretch;
  background: rgba(0,0,0,.35);
  z-index: 3001;
}

/* Ïò§Î•∏Ï™Ω Ïä¨ÎùºÏù¥Îìú Ïù∏ Ìå®ÎÑê */
.aa-drawer {
  width: min(520px, 92vw);
  height: 100vh;
  background: var(--aa-bg);
  box-shadow: -10px 0 30px rgba(0,0,0,.15);
  border-top-left-radius: var(--aa-radius);
  border-bottom-left-radius: var(--aa-radius);
  overflow-y: auto;
  display: flex;
  flex-direction: column;
}

/* Í∑∏ÎùºÎîîÏñ∏Ìä∏ Ìó§Îçî */
.drawer-header {
  background: linear-gradient(135deg, var(--aa-primary) 0%, var(--aa-primary-2) 100%);
  color: #fff;
  padding-bottom: 12px;
}
.drawer-appbar {
  display: flex; align-items: center; justify-content: space-between;
  padding: 12px 12px 4px 12px;
}
.drawer-title { font-size: 18px; font-weight: 700; letter-spacing: .2px; }
.icon-btn, .icon-btn-spacer {
  width: 36px; height: 36px; display: inline-flex; align-items: center; justify-content: center;
  background: rgba(255,255,255,.16); border: 1px solid rgba(255,255,255,.3);
  color: #fff; border-radius: 10px; cursor: pointer;
}
.icon-btn:hover { background: rgba(255,255,255,.22); }
.icon-btn-spacer { visibility: hidden; }

.drawer-hero {
  display: flex; flex-direction: column; align-items: center; text-align: center;
  padding: 10px 12px 12px 12px;
}
.avatar-lg {
  width: 56px; height: 56px; border-radius: 50%;
  display: inline-flex; align-items: center; justify-content: center;
  background: rgba(255,255,255,.2);
  border: 1px solid rgba(255,255,255,.35);
  font-weight: 800; letter-spacing: .5px;
}
.drawer-subtitle { opacity: .95; margin-top: 8px; font-size: 13px; }

/* Î≥∏Î¨∏ */
.drawer-body {
  padding: 16px 16px 96px 16px; /* ÌïòÎã® CTA Ïó¨Ïú† */
  color: var(--aa-text);
}
.sec-title {
  font-size: 14px; font-weight: 700; color: var(--aa-text);
  margin: 16px 0 8px 0;
}
.form-grid {
  display: grid; grid-template-columns: 1fr; gap: 12px;
}

/* ÏûÖÎ†• ÌïÑÎìú */
.field { display: flex; flex-direction: column; gap: 6px; }
.label { font-size: 13px; color: var(--aa-text); font-weight: 600; }
.hint { font-size: 12px; color: var(--aa-muted); }
.hint.center { text-align: center; }
.pv-12 { padding: 12px 0; }

.chip-title-with-icon {
  display: flex;
  align-items: center;
  gap: 4px; /* ÏïÑÏù¥ÏΩòÍ≥º ÌÖçÏä§Ìä∏ ÏÇ¨Ïù¥ Í∞ÑÍ≤© */
}

.chip-icon {
  font-size: 1.2em; /* ÏïÑÏù¥ÏΩò ÌÅ¨Í∏∞ Ï°∞Ï†ï */
  line-height: 1;
  margin-right: 4px; /* ÏïÑÏù¥ÏΩòÍ≥º ÌÉÄÏù¥ÌãÄ ÏÇ¨Ïù¥ Í∞ÑÍ≤© */
}


.input-wrap {
  display: flex; align-items: center; gap: 8px;
  background: #fff;
  border: 1px solid var(--aa-border);
  border-radius: var(--aa-radius);
  padding: 10px 12px;
  box-shadow: 0 0 0 0 rgba(99,102,241,0);
  transition: box-shadow .12s ease, border-color .12s ease, background .12s ease;
}
.input-wrap:focus-within {
  border-color: var(--aa-primary);
  box-shadow: 0 0 0 3px rgba(99,102,241,.18);
}
.input-wrap input {
  flex: 1; border: none; outline: none; background: transparent;
  font-size: 15px; color: var(--aa-text);
}
.fi { font-style: normal; opacity: .8; }

/* Pill ÎùºÎîîÏò§ */
.pill-group {
  display: flex; gap: 8px; overflow-x: auto; padding: 4px 2px 8px 2px;
  -webkit-overflow-scrolling: touch; scrollbar-width: thin;
}
.pill {
  display: inline-flex; align-items: center; padding: 8px 14px;
  background: #F3F4F6; border: 1px solid #E5E7EB; color: #374151;
  border-radius: var(--aa-pill-radius); cursor: pointer; user-select: none;
  transition: background .16s ease, color .16s ease, border-color .16s ease, transform .12s ease;
}
.pill:hover { transform: translateY(-1px); }
.pill.active {
  background: rgba(99,102,241,.12);
  border-color: var(--aa-primary);
  color: #1f2a73;
}
.pill-text { font-size: 14px; font-weight: 600; }
.vh { position: absolute !important; clip: rect(1px,1px,1px,1px); width:1px; height:1px; overflow:hidden; }

/* ÌïòÎã® Í≥†Ï†ï CTA */
.drawer-footer {
  position: sticky; bottom: 0; left: 0; right: 0;
  display: flex; gap: 10px; justify-content: space-between;
  padding: 10px 16px calc(10px + env(safe-area-inset-bottom)) 16px;
  background:
    linear-gradient(to top, rgba(255,255,255,1), rgba(255,255,255,.92) 40%, rgba(255,255,255,0));
  border-top: 1px solid var(--aa-border);
  backdrop-filter: saturate(120%) blur(6px);
}
.btn {
  min-height: 44px; padding: 0 16px; border-radius: var(--aa-radius);
  border: 1px solid var(--aa-border); background: #fff; color: var(--aa-text);
  font-weight: 700; cursor: pointer;
}
.btn.primary {
  background: linear-gradient(135deg, var(--aa-primary) 0%, var(--aa-primary-2) 100%);
  color: #fff; border: none; box-shadow: var(--aa-shadow);
}
.btn.ghost { background: #fff; }

/* Ïò§Î•∏Ï™Ω Ïó¨Î∞± Ï±ÑÏö∞Îäî Ïä§ÌéòÏù¥ÏÑú */
.header-spacer { flex: 1; }

.header-right {
  display: flex;
  gap: 8px;
  align-self: stretch;
  align-items: flex-end;
  /* Ìè≠ Í≥ÑÏÇ∞ÏùÑ ÏúÑÌï¥ Ï∂ïÏÜå ÌóàÏö© */
  min-width: 0;      /* ‚Üê Ï§ëÏöî */
}

/* ÌÉúÍ∑∏Î•º 'ÏãúÍ∞ÅÏ†ÅÏúºÎ°ú' Îçî ÏïÑÎûòÎ°ú ÏÇ¥Ïßù ÎÇ¥Î¶º */
:root { --tag-bottom-nudge: 6px; } /* ÌïÑÏöîÏãú 4~10px ÏÇ¨Ïù¥Î°ú Ï°∞Ï†à */
.header-tags {
  display: flex;
  gap: 6px;
  margin-bottom: 0;              /* ‚Üê Í∏∞Ï°¥ -3px Ï†úÍ±∞ */
  transform: translateY(var(--tag-bottom-nudge));
}
.settings-btn { align-self: center; }


/* === Tag Base === */
/* Ìó§Îçî ÌïòÎã® Ï†ïÎ†¨(Ïú†ÏßÄ) */
.header-right { display:flex; gap:8px; align-self:stretch; align-items:flex-end; }
.header-tags  { display:flex; gap:6px; margin-bottom:2px; }
.settings-btn { align-self:center; }

/* === Tag Base === */
.tag{
  position:relative;
  display:inline-flex; align-items:center; gap:6px;
  font-size:12px; font-weight:700; line-height:1;
  padding:6px 10px; border-radius:999px; color:#fff;
  border:1px solid transparent; box-shadow:0 6px 16px rgba(0,0,0,.10);
  backdrop-filter:saturate(140%) blur(4px);
  transition:transform .15s ease, box-shadow .15s ease;
}
.tag::before{ content:none; }           /* ‚Üê ÏÉæ Ï†úÍ±∞ */
.tag:hover{ transform:translateY(-1px); box-shadow:0 8px 20px rgba(0,0,0,.14); }
.tag > .dot{ width:6px; height:6px; border-radius:50%; display:inline-block; opacity:.95; }
.clickable{ cursor:pointer; }

.loading-label{
  font-size: 13px;
  margin-right: 6px;
  color: #374151; /* ÌöåÏÉâÍ≥Ñ ÌÜ§ */
  vertical-align: middle;
}

/* Íµ¨Î∂Ñ/ÏßÅÏóÖ Í∑∏ÎùºÎç∞Ïù¥ÏÖò (Ïú†ÏßÄ) */
.tag-division{ background:linear-gradient(135deg,var(--tag-div-start),var(--tag-div-end));
               border-color: rgba(99,102,241,var(--tag-border-alpha)); }
.tag-division > .dot{ background:#ECFDF5; }
.tag-job{ background:linear-gradient(135deg,var(--tag-job-start),var(--tag-job-end));
          border-color: rgba(16,185,129,var(--tag-border-alpha)); }
.tag::after{ background:linear-gradient(to bottom, rgba(255,255,255,var(--tag-gloss)), rgba(255,255,255,0)); }
.tag-job > .dot{ background:#ECFDF5; }

/* === Ìó§Îçî ÏïÑÎ∞îÌÉÄ Î≤ÑÌäº === */
.header-avatar-btn{
  -webkit-appearance: none;
  appearance: none;
  padding: 0;
  line-height: 0;

  /* Î≥¥Ïù¥Îäî ÎßÅÏùÄ border ÎåÄÏã† Î∞îÍπ• Í∑∏Î¶ºÏûêÎ°ú */
  border: none; /* ‚Üê Ïù¥Í≤å ÌëúÏãú ÏòÅÏó≠ÏùÑ Ï§ÑÏòÄÏäµÎãàÎã§ */
  box-shadow:
    0 0 0 1px rgba(0,0,0,.08),   /* ÏñáÏùÄ Ïô∏Í≥ΩÏÑ† */
    0 4px 12px rgba(0,0,0,.08);  /* ÏÇ¥Ïßù Í∑∏Î¶ºÏûê */

  width: 32px; height: 32px;
  border-radius: 50%;
  overflow: hidden;
  display: inline-block;        /* flex Î∂àÌïÑÏöî */
  background: #fff;
}
.header-avatar-img{
  width: 100%;
  height: 100%;
  display: block;               /* inline Ïó¨Î∞± Ï†úÍ±∞ */
  object-fit: cover;            /* ÍΩâ Ï±ÑÏö∞Îêò ÏôúÍ≥° ÏóÜÏùå */
  object-position: center;      /* Ï§ëÏã¨ Ï†ïÎ†¨ */
  border-radius: 0;             /* Î∂ÄÎ™®Í∞Ä ÎßàÏä§ÌÇπÌïòÎØÄÎ°ú Î∂àÌïÑÏöî */
}
.header-avatar-fallback{
  font-size:12px; font-weight:800; color:#334155;
}

/* === ÎìúÎ°úÏñ¥ ÏïÑÎ∞îÌÉÄ(ÏóÖÎ°úÎìú Í∞ÄÎä•) === */
.avatar-lg-btn{
  width:56px; height:56px; border-radius:50%;
  display:inline-flex; align-items:center; justify-content:center;
  background: rgba(255,255,255,.2);
  border:1px solid rgba(255,255,255,.35);
  box-shadow:0 8px 24px rgba(0,0,0,.10);
  overflow:hidden; cursor:pointer;
}
.avatar-lg-img{ width:100%; height:100%; object-fit:cover; display:block; }
.avatar-lg-fallback{ font-weight:800; letter-spacing:.5px; color:#fff; }

/* Ï†ëÍ∑ºÏÑ± ÎåÄÎπÑ Î≥¥Ï†ï(Îã§ÌÅ¨) */
@media (prefers-color-scheme: dark){
  .tag{ box-shadow:0 6px 16px rgba(0,0,0,.28); }
}


code { background: #F3F4F6; padding: 0 4px; border-radius: 6px; }

/* ===== Ï†ÑÌôò ===== */
.aa-slide-enter-active,
.aa-slide-leave-active { transition: opacity .2s ease; }
.aa-slide-enter-from,
.aa-slide-leave-to { opacity: 0; }
.aa-slide-enter-to,
.aa-slide-leave-from { opacity: 1; }

/* ÎìúÎ°úÏñ¥ Ïä¨ÎùºÏù¥Îìú Ïù¥Îèô */
.aa-slide-enter-from .aa-drawer,
.aa-slide-leave-to .aa-drawer { transform: translateX(100%); }
.aa-drawer { transform: translateX(0); transition: transform .3s ease; }

html, body {
  height: 100%;
  overflow: hidden;          /* ‚Üê ÌôîÎ©¥ Ï†ÑÏ≤¥ Ïä§ÌÅ¨Î°§ Í∏àÏßÄ */
  overscroll-behavior-y: none; /* iOS Í≥†Î¨¥Ï§Ñ ÏôÑÌôî */
}

.compose-preview-container {
  z-index: 1003; /* Í∏∞Ï°¥ */
}

/* ‚úÖ ÌõÑÏÜç Ï†úÏïà ÏßàÎ¨∏ ÎßêÌíçÏÑ† ÏïûÏúºÎ°ú Ïò§Í≤å */
.suggested-prompts {
  z-index: 1002; /* ÌååÏùº ÎØ∏Î¶¨Î≥¥Í∏∞Î≥¥Îã§ ÎÜíÍ≤å */
}

/* ‚ú® Ï∂îÏ≤ú ÎßêÌíçÏÑ† Ïª®ÌÖåÏù¥ÎÑà(Í≥µÌÜµ) */
.suggested-prompts{
  --gap: 12px;
  position: fixed;
  left: 50%;
  transform: translateX(-50%);
  bottom: 72px;
  width: calc(100% - 32px);
  max-width: 600px;
  display: flex;
  gap: var(--gap);
  overflow-x: auto;
  padding: 8px;
  box-sizing: border-box;
  -webkit-overflow-scrolling: touch;
  z-index: 1001;
  margin-bottom: 16px;
}

/* ‚úÖ ÏùëÎãµ ÌõÑ Ìïú Ï§Ñ Ïπ©(Í∏∞Ï°¥) */
.suggested-prompts .chip{
  flex: 0 0 auto;
  border: 1px solid var(--aa-border);
  background: #fff;
  border-radius: 14px;
  padding: 10px 14px;
  font-size: 13px;
  line-height: 1.2;
  cursor: pointer;
  box-shadow: 0 2px 8px rgba(0,0,0,.08);
  white-space: nowrap;
}
.suggested-prompts .chip:hover{ transform: translateY(-1px); }
.suggested-prompts .chip:active{ transform: translateY(0); box-shadow: 0 2px 8px rgba(0,0,0,.05); }

/* ‚ú® ÏµúÏ¥à ÏßÑÏûÖ 2Ï§Ñ Ïπ©: ÌôîÎ©¥Ïóê 2.5Í∞ú Î≥¥Ïù¥Í∏∞ */
.suggested-prompts.initial .chip-2line{
  /* 2.5Í∞ú = Í∞ÄÏö©Ìè≠ÏùÑ 2.5Î°ú Î∂ÑÌï†. gap Î≥¥Ï†ï(1.5*gap) */
  flex: 0 0 calc((100% - var(--gap) * 1.5) / 2.5);
  min-width: 0;
  white-space: normal;               /* Îëê Ï§Ñ ÌóàÏö© */
  background: #ffffff;               /* Î∞ùÏùÄ ÌöåÏÉâ Î∞ïÏä§ */
  border: 1px solid #e5e7eb;
  border-radius: 16px;
  padding: 12px 14px;
  box-shadow: 0 2px 8px rgba(0,0,0,.06);
  display: flex;
  flex-direction: column;
  align-items: flex-start;
}

/* Î°úÎî© Ïπ© */
.suggested-prompts .chip-loading{
  display: inline-flex;
  align-items: center;
  gap: 8px;
  border: 1px solid var(--aa-border);
  background: #fff;
  border-radius: 14px;
  padding: 10px 14px;
  font-size: 13px;
  box-shadow: 0 2px 8px rgba(0,0,0,.08);
}
.loading-dots { display: inline-flex; gap: 4px; height: 16px; align-items: baseline;}
.loading-dots .dot{
  width: 6px; height: 6px; border-radius: 50%;
  background-color: #666; animation: blink 1.4s infinite ease-in-out both;
}
.loading-dots .dot:nth-child(2){ animation-delay:.2s }
.loading-dots .dot:nth-child(3){ animation-delay:.4s }

/* 2Ï§Ñ Ïπ© ÌÖçÏä§Ìä∏ Ïª¨Îü¨: Ï†úÎ™©=ÌååÎûÄÍ≥ÑÏó¥, ÏÑ§Î™Ö=ÏßôÏùÄ ÌöåÏÉâ */
.suggested-prompts.initial .chip-2line .chip-title{
  font-size: 14px;
  font-weight: 800;
  color: #2563eb;                    /* ÌååÎûÄÏÉâ Í≥ÑÏó¥ */
  margin-bottom: 4px;
}
.suggested-prompts.initial .chip-2line .chip-desc{
  font-size: 12px;
  font-weight: 600;
  color: #1f2937;                    /* Í≤ÄÏùÄ ÏßÑÌïú ÌöåÏÉâ */
}

/* ÏóÖÎ°úÎìú Ï¢ÖÎ•ò ÏÑ†ÌÉù Î©îÎâ¥ */
.picker-menu{
  position: absolute;
  left: 8px;             /* + Î≤ÑÌäº Í∑ºÏ≤ò */
  bottom: 52px;          /* ÏûÖÎ†•Ï∞Ω ÏúÑÎ°ú ÏÇ¥Ïßù */
  display: flex;
  flex-direction: column;
  gap: 6px;
  padding: 8px;
  background: #fff;
  border: 1px solid var(--aa-border);
  border-radius: 10px;
  box-shadow: 0 8px 24px rgba(0,0,0,.12);
  z-index: 1301;
}
.picker-item{
  appearance: none;
  border: 1px solid var(--aa-border);
  background: #f9fafb;
  border-radius: 8px;
  padding: 8px 10px;
  font-size: 13px;
  text-align: left;
  cursor: pointer;
}
.picker-item:hover{ background:#f3f4f6; }

/* Ï¥àÍ∏∞ ÏßàÎ¨∏ Î≥µÍ∑Ä Ïπ© Ïä§ÌÉÄÏùº */
.chip-reset {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  padding: 8px;
  background: #f3f4f6;
  border: 1px solid var(--aa-border);
  border-radius: 14px;
  cursor: pointer;
  box-shadow: 0 2px 8px rgba(0,0,0,.08);
}
.chip-reset:hover {
  background: #e5e7eb;
}
.chip-reset svg {
  stroke: #2563eb; /* ÌååÎûÄ Í≥ÑÏó¥ Í∞ïÏ°∞ */
}

/* Ï¥àÍ∏∞ Ïπ© Ïª®ÌÖåÏù¥ÎÑà: Í∏∞Î≥∏ 1Ï§Ñ(Í∞ÄÎ°ú Ïä§ÌÅ¨Î°§), ÌôïÏû• Ïãú Ï§ÑÎ∞îÍøà */
.suggested-prompts.initial { flex-wrap: nowrap; }
.suggested-prompts.initial.expanded {
  flex-wrap: wrap;              /* ‚úÖ 2Ï§Ñ Ïù¥ÏÉÅ ÌóàÏö© */
  overflow-x: visible;          /* Í∞ÄÎ°ú Ïä§ÌÅ¨Î°§ Ìï¥Ï†ú */
}

/* 2Ï§Ñ Ïπ©(Í∏∞Î≥∏ 2.5Í∞ú Î≥¥Ïù¥Í∏∞) */
.suggested-prompts.initial .chip-2line{
  flex: 0 0 calc((100% - var(--gap) * 1.5) / 2.5);
  min-width: 0;
}

/* ÌôïÏû• ÏãúÎäî 2Ïó¥(=Ïπ©Ïù¥ 2Ï§Ñ Ïù¥ÏÉÅ)Î°ú ÏûêÏó∞Ïä§ÎüΩÍ≤å ÍΩâ Ï±ÑÏö∞Í∏∞ */
.suggested-prompts.initial.expanded .chip-2line{
  flex: 1 1 calc(50% - var(--gap)); /* ‚úÖ 2Ïó¥ */
}

/* Îçî Î≥¥Í∏∞ Ïπ© Í∞ïÏ°∞(Ï†êÏÑ† ÌÖåÎëêÎ¶¨) */
.suggested-prompts.initial .chip-more{
  border-style: dashed;
  background: #ffffff;
  border-color: #e5e7eb;
}

/* ‚úÖ ÎûòÌçºÎ•º 'ÌôîÎ©¥ ÎÜíÏù¥'Ïóê Îî± ÎßûÏ∂îÍ∏∞ (100vh ÎåÄÏã†) */
@supports (height: 100dvh) {
  .chat-wrapper { height: 100dvh; }
}
@supports not (height: 100dvh) {
  .chat-wrapper { height: 100svh; }
}

/* Î∞òÏùëÌòï */
@media (max-width: 768px) {
  .chat-messages { margin-bottom: 190px; }
  html, body { touch-action: manipulation; }
  .chat-bubble.bot {
    margin-left: 0;      /* ÏôºÏ™Ω Ïó¨Î∞± Ï†úÍ±∞ */
    padding-left: 4px;   /* ÎßêÌíçÏÑ† ÏïàÏ™Ω Ìå®Îî©ÏùÄ ÏµúÏÜå Ïú†ÏßÄ */
  }

  .chat-bubble.bot .avatar {
    margin-right: 1px;   /* ÏïÑÎ∞îÌÉÄÏôÄ ÎßêÌíçÏÑ† ÏÇ¨Ïù¥ Í∞ÑÍ≤© Ï∂ïÏÜå */
    width: 1px;         /* ÏïÑÎ∞îÌÉÄ ÌÅ¨Í∏∞ÎèÑ Î™®Î∞îÏùºÏóê ÎßûÍ≤å Ï∂ïÏÜå */
    height: 1px;
  }
}

/* Î™®Î∞îÏùºÏóêÏÑú ÏÇ¥Ïßù Îçî ÎÇ¥Î¶¨Í≥† Ïã∂Îã§Î©¥ */
@media (max-width: 480px) {
  .header-tags { transform: translateY(4px); }
  .header-avatar-btn{ width:28px; height:28px; }
  .tag{ padding:5px 8px; font-size:11px; }
  .suggested-prompts.initial .chip-2line{
    flex: 0 0 calc((100% - var(--gap)) / 2.2);
  }
  .suggested-prompts.initial.expanded .chip-2line{
    flex: 1 1 calc(50% - var(--gap));
  }
}

/* Ïï†ÎãàÎ©îÏù¥ÏÖò */
@keyframes blink { 0%,80%,100% {opacity:0;} 40% {opacity:1;} }
@keyframes pulse-bg {
  0% { background-color: rgba(240,248,255,0.5); backdrop-filter: blur(1px); }
  50% { background-color: rgba(240,248,255,0.75); backdrop-filter: blur(3px); }
  100% { background-color: rgba(240,248,255,0.5); backdrop-filter: blur(1px); }
}
@keyframes fadeInOut {
  0% { opacity:0; transform: translateX(-50%) translateY(-10px); }
  10%,90% { opacity:1; transform: translateX(-50%) translateY(0); }
  100% { opacity:0; transform: translateX(-50%) translateY(-10px); }
}
.enough {
  color: #2563eb; /* ÌååÎûÄÏÉâ */
  font-weight: 700;
}
.lack {
  color: #dc2626; /* Îπ®Í∞ÑÏÉâ */
  font-weight: 700;
}
</style>
